# TaoGrid 4种Regime策略对比分析

**测试日期**: 2025-12-21
**实验类型**: 4种Regime策略横向对比（包含做空功能测试）

---

## 实验设计

### 测试时间段

- **原计划**: 2024-11-27 至 2025-01-25 (60天)
- **实际测试**: 2024-12-21 至 2025-01-24 (35天)
  - 受限于数据缓存范围
  - **所有4个测试使用相同时间段，对比有效**

### 控制变量（相同参数）

| 参数 | 值 |
|------|-----|
| **支撑位** | $90,000 |
| **阻力位** | $108,000 |
| **区间大小** | 20.0% ($18,000) |
| **杠杆** | 5x |
| **初始资金** | $100,000 |
| **手续费** | 0.02% |
| **网格层数** | 40 buy / 40 sell |
| **边缘加重** | k=0.0（均匀分配） |
| **P0修复** | inventory_regime_gamma=1.2, cost_basis_risk_zone=True |
| **风险控制** | 全部启用（MM Risk Zone, 趋势, 突破, 资金费率, 波动率, 库存） |

### 测试策略（唯一变量）

| # | Regime | 买入预算 | 卖出预算 | 做空 | 说明 |
|---|--------|---------|---------|------|------|
| 1 | NEUTRAL_RANGE | 50% | 50% | ❌ | 中性震荡 |
| 2 | BULLISH_RANGE | 70% | 30% | ❌ | 震荡看多 |
| 3 | BEARISH_RANGE | 30% | 70% | ✅ | 震荡看空（可做空） |
| 4 | BEARISH_RANGE | 30% | 70% | ❌ | 震荡看空（只做多） |

---

## 核心指标对比

### 回报与风险

| Regime | 总回报 | 年化回报 | 最大回撤 | Sharpe | Sortino | Calmar | Sharpe/MaxDD | Ulcer Index |
|--------|--------|---------|---------|--------|---------|--------|--------------|-------------|
| **NEUTRAL (50/50)** | **14.40%** | **307.21%** | **-10.25%** | **4.42** | **6.11** | **29.96** | **43.11** | **1.32** |
| **BULLISH (70/30)** | **14.22%** | **334.66%** | **-22.46%** ⚠️ | **2.27** | **3.67** | **14.90** | **10.08** | **7.50** ⚠️ |
| **BEARISH Short (30/70)** | **8.53%** | **135.25%** | **-6.43%** | **4.23** | **6.75** | **21.03** | **65.80** | **0.84** |
| **BEARISH Long-only (30/70)** | **8.92%** | **144.36%** | **-6.43%** | **4.47** | **6.19** | **22.45** | **69.48** | **0.82** |

### 交易质量

| Regime | 总交易数 | 交易/天 | 胜率 | 平均盈利 | 平均亏损 | 盈亏比 | 盈利因子 | 持仓时间 |
|--------|---------|--------|------|---------|---------|--------|---------|---------|
| **NEUTRAL (50/50)** | **1491** | **42.6** | **91.75%** | **$14.76** | **$-48.19** | **0.31** | **3.41** | **15.0h** |
| **BULLISH (70/30)** | **222** | **6.3** | **100.00%** 🔥 | **$7.74** | **N/A** | **N/A** | **N/A** | **82.2h** ⚠️ |
| **BEARISH Short (30/70)** | **1470** | **42.0** | **91.16%** | **$9.32** | **$-28.79** | **0.32** | **3.34** | **15.1h** |
| **BEARISH Long-only (30/70)** | **1488** | **42.5** | **91.26%** | **$9.29** | **$-28.79** | **0.32** | **3.37** | **14.9h** |

### 回撤恢复能力

| Regime | 回报/回撤比 | Calmar Ratio | Sharpe/MaxDD | 风险调整回报评级 |
|--------|------------|--------------|--------------|---------------|
| **NEUTRAL (50/50)** | **1.40** | **29.96** | **43.11** | ⭐⭐⭐⭐⭐ |
| **BULLISH (70/30)** | **0.63** | **14.90** | **10.08** | ⭐⭐⭐ |
| **BEARISH Short (30/70)** | **1.33** | **21.03** | **65.80** | ⭐⭐⭐⭐⭐ |
| **BEARISH Long-only (30/70)** | **1.39** | **22.45** | **69.48** | ⭐⭐⭐⭐⭐ |

---

## 详细分析

### 1. NEUTRAL_RANGE (50/50) - 最均衡 ✅

**表现**:
- ✅ 最高回报: 14.40%（年化307%）
- ✅ 回撤可控: -10.25%
- ✅ 优秀Sharpe: 4.42
- ✅ 高频交易: 1491笔（42.6笔/天）
- ✅ 短持仓: 15小时

**特点**:
- 买卖预算平衡（50/50）→ 库存周转快
- 高频交易 → 利润来自频繁配对平仓
- 低回撤 → 风险管理有效，库存不堆积
- **综合表现最佳**

**适用场景**:
- ✅ 震荡市场（测试期间确实是震荡）
- ✅ 风险厌恶型交易者
- ✅ 实盘首选策略

---

### 2. BULLISH_RANGE (70/30) - 高回撤预警 ⚠️

**表现**:
- ✅ 回报与NEUTRAL相近: 14.22%（年化335%）
- ❌ **回撤2倍于NEUTRAL**: -22.46% vs -10.25%
- ❌ **Sharpe显著降低**: 2.27 vs 4.42
- ⚠️ 交易少很多: 222笔 vs 1491笔
- ⚠️ 持仓时间长5倍: 82.2小时 vs 15小时
- 🔥 **100%胜率**（惊人）
- 🔥 **零亏损交易**

**问题分析**:

#### 为什么回报相近但回撤高2倍？

**原因**: 库存堆积 + 浮亏风险

```
买入预算70% → 快速积累库存 → 持仓时间长（82h）→ 价格回调时浮亏大

数据证据（2025-01-13 14:36调试日志）:
- Holdings: 1.9154 BTC
- Cost Basis: $187,186 (平均成本~$97.7k/BTC)
- Price: $89,978
- Unrealized Loss: -$14,846 (-17.18% equity)
- Equity: $86,409
- Max Drawdown: -22.46%
```

**对比NEUTRAL同时刻**:
```
- Holdings: 1.8310 BTC（相近）
- Cost Basis: $172,898 (平均成本~$94.4k/BTC)
- Unrealized Loss: -$8,150 (-8.13% equity)
- Equity: $100,312
- Max Drawdown: -10.25%
```

**关键差异**:
- BULLISH成本价更高（$97.7k vs $94.4k）
- BULLISH持仓时间长 → 更多高价位买入没来得及卖出
- 浮亏翻倍（-17.18% vs -8.13%）

#### P0修复有效但不够

**修复前**（2024-12-30 to 2025-01-20, 22天）:
- 回撤: **-47.2%**
- Sharpe: 4.07
- Holdings: 5.01 BTC

**修复后**（本次测试，35天）:
- 回撤: **-22.46%**（改善52%）✅
- Sharpe: 2.27（下降44%）⚠️
- Holdings: 1.9154 BTC（显著降低）✅

**结论**: P0修复显著降低了回撤（-47% → -22%），但仍是NEUTRAL的2倍，**需进一步优化**。

#### 为什么100%胜率？

**原因**: 只有已平仓的盈利交易被记录

```
222笔交易 = 222次成功配对（买入后成功卖出）
所有交易都是盈利 → 100%胜率

但！
- 1.9154 BTC持仓未平仓（浮亏-17.18%）
- 这些未平仓的浮亏不计入"交易统计"
- 如果算上浮亏 → 实际胜率会降低
```

**启示**: **不能只看交易胜率，必须看最大回撤和Ulcer Index**

---

### 3. BEARISH_RANGE with SHORT (30/70) - 做空无优势 ⚠️

**表现**:
- 回报: 8.53%（低于NEUTRAL和BULLISH）
- 回撤: -6.43%（最低！）
- Sharpe: 4.23（优秀）
- 交易: 1470笔（高频）
- 持仓: 15.1小时（短）

**为什么做空模式回报更低？**

**市场环境不匹配**:
```
测试期间: 2024-12-21 to 2025-01-24
市场走势: 震荡上涨（$92k → $106k，底部抬高）

BEARISH with SHORT:
- 期望: 价格下跌时做空盈利
- 现实: 价格震荡上涨 → 做空亏损或收益有限
- 结果: 回报8.53%（低于long-only 8.92%）
```

**数据对比**（同时刻2025-01-13 14:36）:
```
BEARISH Short:
- Holdings: 1.1085 BTC
- Cost: $104,629 (平均$94.4k/BTC)
- Unrealized Loss: -$4,887 (-4.87%)
- Max Drawdown: -6.43%

BEARISH Long-only:
- Holdings: 1.1085 BTC（相同！）
- Cost: $104,629（相同！）
- Unrealized Loss: -$4,887（相同！）
- Max Drawdown: -6.43%（相同！）
```

**说明**: 在这个时间段，做空功能没有被触发或收益有限，两个策略几乎相同。

---

### 4. BEARISH_RANGE Long-only (30/70) - 保守稳健 ✅

**表现**:
- 回报: 8.92%（比SHORT稍高）
- 回撤: -6.43%（与SHORT相同，最低）
- Sharpe: 4.47（比SHORT稍高）
- 交易: 1488笔（高频）
- 持仓: 14.9小时（短）

**特点**:
- 买入预算少（30%）→ 库存积累慢
- 卖出预算多（70%）→ 快速平仓
- 高频交易 → 利润来自频繁配对
- **最低回撤**（-6.43%）
- **最低Ulcer Index**（0.82，路径最平滑）

**适用场景**:
- ✅ 震荡下跌市场（理论上，但本次测试是上涨）
- ✅ 极度风险厌恶型
- ✅ 回撤控制优先

**问题**: 回报低于NEUTRAL（8.92% vs 14.40%）

---

## 关键发现

### 1. P0修复有效但仍需改进

**BULLISH_RANGE回撤改善**:
```
修复前: -47.2%（2024-12-30 to 2025-01-20）
修复后: -22.46%（2024-12-21 to 2025-01-24）
改善: 52% ✅

但仍是NEUTRAL的2倍:
NEUTRAL: -10.25%
BULLISH: -22.46%（219%）
```

**原因**: BULLISH的库存堆积问题仍然存在
- 70%买入预算 → 持仓时间长（82h vs 15h）
- 成本价更高 → 浮亏更大

### 2. 做空功能在震荡上涨中无优势

**BEARISH Short vs Long-only**:
```
Short:      8.53%  -6.43%  4.23  1470笔
Long-only:  8.92%  -6.43%  4.47  1488笔

差异: 微小（<5%）
```

**结论**: 在震荡上涨市场，做空功能收益有限甚至略低于long-only

**启示**: 做空功能需要在真正的震荡下跌市场中测试才能验证价值

### 3. NEUTRAL_RANGE综合表现最佳

**为什么NEUTRAL最好？**

| 维度 | NEUTRAL优势 | 原因 |
|------|------------|------|
| **回报** | 最高（14.40%） | 高频交易，库存周转快 |
| **回撤** | 适中（-10.25%） | 买卖平衡，库存不堆积 |
| **Sharpe** | 优秀（4.42） | 高回报 + 适中波动 |
| **交易频率** | 最高（42.6笔/天） | 买卖预算平衡 → 配对快 |
| **持仓时间** | 最短（15h） | 快速周转 → 减少浮亏风险 |
| **路径稳定** | Ulcer 1.32 | 适中（不是最低但可接受） |

**对比其他策略**:
- BULLISH: 回报相近（14.22%）但回撤高2倍（-22.46%）
- BEARISH: 回撤最低（-6.43%）但回报低40%（8.92%）

**结论**: NEUTRAL在回报与风险之间达到最佳平衡

### 4. 胜率不能代表一切

**BULLISH的100%胜率陷阱**:
```
胜率: 100%（222笔全部盈利）
但！
回撤: -22.46%（NEUTRAL的2倍）
Ulcer: 7.50（NEUTRAL的5.7倍）

原因: 未平仓浮亏不计入胜率
```

**正确的评估指标**:
1. ✅ 最大回撤（Max Drawdown）
2. ✅ Sharpe Ratio（风险调整后回报）
3. ✅ Ulcer Index（路径波动性）
4. ✅ Calmar Ratio（年化回报/回撤）
5. ⚠️ 胜率（参考，但不是核心）

---

## 实盘建议

### 推荐策略排序（基于风险调整后表现）

#### 1. NEUTRAL_RANGE (50/50) ⭐⭐⭐⭐⭐

**推荐度**: 最高
**适用**: 震荡市场（方向不明确）

**优势**:
- ✅ 最高回报（14.40%）
- ✅ 可控回撤（-10.25%）
- ✅ 优秀Sharpe（4.42）
- ✅ 高频交易，灵活应对

**参数**:
```python
regime = "NEUTRAL_RANGE"
inventory_regime_gamma = 1.2
enable_cost_basis_risk_zone = True
leverage = 5.0
```

**预期年化**: 300%+，回撤<15%

---

#### 2. BEARISH_RANGE Long-only (30/70) ⭐⭐⭐⭐

**推荐度**: 高（保守型）
**适用**: 风险厌恶，回撤控制优先

**优势**:
- ✅ 最低回撤（-6.43%）
- ✅ 最平滑路径（Ulcer 0.82）
- ✅ 优秀Sharpe（4.47）
- ⚠️ 回报较低（8.92%）

**参数**:
```python
regime = "BEARISH_RANGE"
enable_short_in_bearish = False  # Long-only
inventory_regime_gamma = 1.2
enable_cost_basis_risk_zone = True
leverage = 5.0
```

**预期年化**: 140%+，回撤<10%

---

#### 3. BEARISH_RANGE with SHORT (30/70) ⭐⭐⭐⭐

**推荐度**: 高（需验证）
**适用**: 震荡下跌市场（待测试）

**当前表现**:
- 在震荡上涨中与long-only相近（8.53% vs 8.92%）
- 做空功能未充分发挥

**需要**:
- 在真正的震荡下跌市场测试
- 验证做空功能的增益效果

**参数**:
```python
regime = "BEARISH_RANGE"
enable_short_in_bearish = True  # Enable short
short_breakout_block_threshold = 0.95
inventory_regime_gamma = 1.2
enable_cost_basis_risk_zone = True
leverage = 5.0
```

**预期**: 在下跌市场中应优于long-only

---

#### 4. BULLISH_RANGE (70/30) ⭐⭐⭐

**推荐度**: 中等（需进一步优化）
**适用**: 明确看多且能承受回撤

**问题**:
- ❌ 回撤高2倍（-22.46% vs NEUTRAL -10.25%）
- ❌ Sharpe低（2.27 vs NEUTRAL 4.42）
- ❌ Ulcer高5.7倍（7.50 vs NEUTRAL 1.32）

**优势**:
- ✅ 回报与NEUTRAL相近（14.22%）
- ✅ 100%胜率（已平仓交易）

**优化方向**:
1. **进一步降低库存容量**:
   ```python
   inventory_regime_gamma = 1.5  # 从1.2提高到1.5
   ```

2. **降低杠杆**:
   ```python
   leverage = 3.0  # 从5x降到3x
   ```

3. **启用P1强制减仓**（如果P0仍不够）:
   ```python
   enable_deleverage = True
   deleverage_level1_unrealized_loss_pct = 0.15  # 浮亏15%触发
   ```

**预期优化后**:
- 回撤: -22% → -12% to -15%
- Sharpe: 2.27 → 3.5 to 4.0
- 回报: 14.22% → 10% to 12%（略降）

---

## 进一步测试建议

### 1. 测试更长时间段

**当前**: 35天（受限于数据缓存）
**建议**: 测试完整的60天或更长（90天+）

**目的**: 验证策略在更多市场环境下的稳健性

### 2. 测试震荡下跌市场

**当前**: 震荡上涨（$92k → $106k）
**建议**: 找一个明确的震荡下跌时期

**目的**: 验证BEARISH Short的做空功能是否真的有效

**候选时期**:
- 2024年8月（$70k → $50k下跌）
- 2024年4月（$73k → $56k下跌）

### 3. 测试BULLISH进一步优化

**P0修复效果**: 回撤-47% → -22%（改善52%）

**下一步优化**:
```python
# 方案A: 更激进的库存限制
inventory_regime_gamma = 1.5  # 或1.8

# 方案B: 降低杠杆
leverage = 3.0

# 方案C: 启用P1强制减仓
enable_deleverage = True
deleverage_level1_unrealized_loss_pct = 0.15
deleverage_level1_sell_mult = 2.0
```

**目标**: 将BULLISH回撤降到-15%以下，同时保持回报>10%

---

## 总结

### 核心结论

1. **NEUTRAL_RANGE是当前最佳策略** ✅
   - 最高回报（14.40%）
   - 可控回撤（-10.25%）
   - 优秀Sharpe（4.42）
   - 高频灵活

2. **P0修复显著改善BULLISH** ✅
   - 回撤从-47%降到-22%（改善52%）
   - 但仍需进一步优化才能达到NEUTRAL水平

3. **做空功能需要合适市场环境** ⚠️
   - 在震荡上涨中收益有限
   - 需在震荡下跌市场验证

4. **BEARISH Long-only是保守之选** ✅
   - 最低回撤（-6.43%）
   - 最平滑路径（Ulcer 0.82）
   - 适合风险厌恶型

### 实盘路径建议

**阶段1: 启动阶段**（1-3个月）
- 使用**NEUTRAL_RANGE**
- 验证实盘执行与回测一致性
- 预期年化300%+，回撤<15%

**阶段2: 扩展阶段**（3-6个月）
- 根据市场环境切换regime:
  - 震荡不明确 → NEUTRAL_RANGE
  - 明确看多 → BULLISH_RANGE（优化后）
  - 明确看空 → BEARISH_RANGE with SHORT
- 测试做空功能在下跌市场的表现

**阶段3: 优化阶段**（6个月+）
- 动态调整regime参数
- 基于实盘数据优化P0/P1参数
- 开发regime自动切换逻辑

---

**测试完成日期**: 2025-12-21
**结果目录**:
- `run/results_4regimes_neutral/`
- `run/results_4regimes_bullish/`
- `run/results_4regimes_bearish_short/`
- `run/results_4regimes_bearish_longonly/`
