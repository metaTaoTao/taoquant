# TaoGrid 仓位管理体系（极简版）

**代码位置**:
- `algorithms/taogrid/helpers/grid_manager.py:504-835`
- `analytics/indicators/grid_weights.py`

---

## 核心理念

**不是平均分配，而是智能分配**

- 普通网格：每个价格层级下单大小一样
- TaoGrid：
  1. 边界层级下单大（风险回报比好）
  2. 中间层级下单小（风险回报比差）
  3. 看涨多买少卖，看跌少买多卖
  4. 根据市场条件动态调整

---

## 一、基础仓位计算

**代码**: `grid_manager.py:554-571`

### 公式
```python
总预算 = 本金 × 风险预算比例      # 例：$100,000 × 30% = $30,000
层级预算 = 总预算 × 层级权重      # 例：$30,000 × 14% = $4,200
基础大小 = 层级预算 / 价格 × 杠杆  # 例：$4,200 / $98,000 × 5 = 0.214 BTC
```

### 参数
- **风险预算比例** (risk_budget_pct): 默认30%
  - 含义：用本金的30%来分配所有网格订单
- **杠杆** (leverage): 默认5x
  - 含义：$100,000本金可开$500,000仓位

### 示例
本金$100,000，风险预算30%，杠杆5x：
- 总预算 = $30,000
- 最大名义仓位 = $30,000 × 5 = $150,000
- BTC价格$100,000时，最大持仓 = 1.5 BTC

---

## 二、层级权重分配（边缘加重）

**代码**: `grid_weights.py:35-91 calculate_level_weights()`

### 原理：越靠近边界，权重越大

**为什么**？
- 边界价格（支撑/阻力附近）：大概率反弹，风险回报比高
- 中间价格：可能继续波动，风险回报比低

### 公式
```python
raw_weight(i) = 1 + k × (i - 1)
weight(i) = raw_weight(i) / Σraw_weight
```

### 示例：4层网格，k=0.5

| 层级 | 位置 | 原始权重 | 归一化权重 | 含义 |
|------|------|----------|------------|------|
| L1 | 最靠近中间 | 1.0 | 14.3% | 最小仓位 |
| L2 | 中间 | 1.5 | 21.4% | 小仓位 |
| L3 | 接近边界 | 2.0 | 28.6% | 中仓位 |
| L4 | 最靠近边界 | 2.5 | 35.7% | **最大仓位** |

### 参数 k 的影响
- **k=0**: 所有层级一样大（25%, 25%, 25%, 25%）
- **k=0.5**: 边缘加重（14%, 21%, 29%, 36%）
- **k=1.0**: 更加边缘加重（10%, 20%, 30%, 40%）

---

## 三、区间制度分配（看涨看跌）

**代码**: `grid_weights.py:94-156 allocate_side_budgets()`

### 逻辑：根据对市场的判断，调整买/卖预算比例

| 制度 | 买单预算 | 卖单预算 | 适用场景 |
|------|---------|---------|---------|
| **看涨区间** (UP_RANGE) | 70% | 30% | 震荡上涨 |
| **中性区间** (NEUTRAL_RANGE) | 50% | 50% | 纯震荡 |
| **看跌区间** (DOWN_RANGE) | 30% | 70% | 震荡下跌 |

### 示例：本金$100,000，风险预算30%

**中性区间** (当前回测用的):
- 总预算 = $30,000
- 买单预算 = $15,000（50%）
- 卖单预算 = $15,000（50%）

**看涨区间**（如果判断会涨）:
- 买单预算 = $21,000（70%）→ 更积极做多
- 卖单预算 = $9,000（30%）→ 减少卖出

**看跌区间**（如果判断会跌）:
- 买单预算 = $9,000（30%）→ 减少买入
- 卖单预算 = $21,000（70%）→ 更积极减仓

---

## 四、完整仓位计算示例

假设：
- 本金 = $100,000
- 风险预算 = 30%
- 杠杆 = 5x
- 制度 = 中性区间
- 网格层数 = 4层买 + 4层卖
- 边缘加重系数 k = 0.5

### 步骤1：总预算
```
总预算 = $100,000 × 30% = $30,000
```

### 步骤2：买/卖预算分配
```
买单总预算 = $30,000 × 50% = $15,000
卖单总预算 = $30,000 × 50% = $15,000
```

### 步骤3：计算层级权重
```
买L1: 14.3%, 买L2: 21.4%, 买L3: 28.6%, 买L4: 35.7%
卖L1: 14.3%, 卖L2: 21.4%, 卖L3: 28.6%, 卖L4: 35.7%
```

### 步骤4：买单大小（价格递减）

| 层级 | 价格 | 层级预算 | BTC数量 | 名义价值 |
|------|------|----------|---------|---------|
| 买L1 | $99,000 | $15,000×14.3%=$2,145 | 0.108 BTC | $10,725 |
| 买L2 | $98,000 | $15,000×21.4%=$3,210 | 0.164 BTC | $16,050 |
| 买L3 | $97,000 | $15,000×28.6%=$4,290 | 0.221 BTC | $21,450 |
| 买L4 | $96,000 | $15,000×35.7%=$5,355 | 0.279 BTC | **$26,775** |

**总计**: 0.772 BTC，名义价值 $75,000（加杠杆5x）

### 步骤5：卖单大小（价格递增）

| 层级 | 价格 | 层级预算 | BTC数量 | 名义价值 |
|------|------|----------|---------|---------|
| 卖L1 | $101,000 | $15,000×14.3%=$2,145 | 0.106 BTC | $10,725 |
| 卖L2 | $102,000 | $15,000×21.4%=$3,210 | 0.157 BTC | $16,050 |
| 卖L3 | $103,000 | $15,000×28.6%=$4,290 | 0.208 BTC | $21,450 |
| 卖L4 | $104,000 | $15,000×35.7%=$5,355 | 0.257 BTC | **$26,775** |

**总计**: 0.728 BTC，名义价值 $75,000（加杠杆5x）

---

## 五、动态调整链（每次下单时）

**代码**: `grid_manager.py:504-835 calculate_order_size()`

基础大小计算完后，还要经过一系列动态调整：

```
基础大小（equity × risk_pct × weight / price × leverage）
  ↓
× 库存偏斜调整（inventory_skew_k）
  库存越高，买单越小（0-100%范围）
  ↓
× MM风险区调整（如果在风险区）
  Level 1: 买20%, 卖300%
  Level 3: 买5%, 卖500%
  ↓
× 趋势因子调整（MR+Trend）
  强下跌: 买0%（完全阻止）
  弱下跌: 买50-100%
  ↓
× 突破风险调整（Breakout Risk）
  接近边界: 买40-100%
  突破风险高: 买0%（完全阻止）
  ↓
× 资金费率调整（Funding）
  费率高: 买40-100%，卖100-200%
  费率超高: 买0%（完全阻止）
  ↓
× 区间位置调整（Range Position）
  接近顶部: 买20-100%，卖100-150%
  ↓
× 波动率调整（Volatility）
  极端高波: 卖115%
  ↓
× 卖单限制（BUG FIX）
  卖单大小 ≤ 对应买单大小
  防止错误配对
  ↓
× Throttle调整（如果启用）
  库存/利润/波动节流
  ↓
最终大小（可能是基础大小的0-500%）
```

---

## 六、动态调整效果示例

假设买L1基础大小 = 0.1 BTC

### 场景1：正常市场
```
0.1 BTC
× 1.0 (库存正常)
× 1.0 (不在风险区)
× 1.0 (趋势正常)
× 1.0 (无突破风险)
× 1.0 (资金费率正常)
= 0.1 BTC (100%基础大小)
```

### 场景2：接近支撑 + 高库存
```
0.1 BTC
× 0.5 (库存70%，减少50%)
× 0.2 (Level 1风险区，买20%)
× 1.0 (趋势正常)
× 1.0 (无突破风险)
× 1.0 (资金费率正常)
= 0.01 BTC (10%基础大小)
```

### 场景3：强下跌趋势
```
0.1 BTC
× 1.0 (库存正常)
× 1.0 (不在风险区)
× 0.0 (强下跌，完全阻止)
= 0 BTC (不下单)
```

### 场景4：卖单在风险区
```
0.1 BTC (基础卖单)
× 3.0 (Level 1风险区，卖300%)
× 1.5 (接近阻力，卖150%)
× 1.15 (高波动，卖115%)
= 0.518 BTC (518%基础大小!)

限制到对应买单大小:
min(0.518, 对应买单总大小0.1) = 0.1 BTC
```

---

## 七、关键参数表

| 参数 | 默认值 | 含义 | 影响 |
|------|--------|------|------|
| **基础配置** | | | |
| risk_budget_pct | 0.3 | 用本金的30%分配网格 | 越大→仓位越大 |
| leverage | 5.0 | 杠杆倍数 | 越大→仓位越大 |
| weight_k | 0.5 | 边缘加重系数 | 越大→边界仓位越大 |
| **区间制度** | | | |
| NEUTRAL_RANGE | 50/50 | 买卖各50% | 中性震荡 |
| UP_RANGE | 70/30 | 买70%卖30% | 看涨 |
| DOWN_RANGE | 30/70 | 买30%卖70% | 看跌 |
| **库存管理** | | | |
| inventory_skew_k | 1.0 | 库存感知强度 | 越大→库存高时买单减少越多 |
| inventory_capacity_threshold_pct | 0.9 | 库存容量阈值 | 超过后阻止买入 |

---

## 八、与普通网格的对比

| 特性 | 普通网格 | TaoGrid |
|------|---------|---------|
| **仓位分配** | 所有层级一样大 | 边界大，中间小 |
| **方向偏好** | 无 | 可设置70/30, 50/50, 30/70 |
| **库存感知** | 无 | 库存高时自动减少买入 |
| **风险调整** | 无 | 风险区自动调整（5-500%） |
| **因子过滤** | 无 | 5个因子动态调整 |
| **配对保证** | 无 | 卖单限制到买单大小 |

### 示例对比（4层网格，$10,000预算）

**普通网格**:
```
买L1: $2,500 → 0.025 BTC
买L2: $2,500 → 0.026 BTC
买L3: $2,500 → 0.026 BTC
买L4: $2,500 → 0.026 BTC
（每层一样大）
```

**TaoGrid（边缘加重）**:
```
买L1: $1,430 → 0.014 BTC（最小）
买L2: $2,140 → 0.022 BTC
买L3: $2,860 → 0.029 BTC
买L4: $3,570 → 0.037 BTC（最大，2.6倍L1）
（越靠近支撑越大）
```

---

## 九、实际案例（当前回测）

**配置**:
- 本金: $100,000
- 风险预算: 30%
- 杠杆: 5x
- 支撑/阻力: $92,000 - $106,000
- 制度: 中性区间（50/50）
- 网格间距: ~0.12% (动态ATR)
- 层数: ~30层买 + 30层卖

**效果**:
- 总交易: 1009笔
- 胜率: 92.17%
- 配对正确率: 84%
- 平均持仓时间: 6.6小时
- Sharpe: 5.94

**关键**:
1. 边缘加重让支撑/阻力附近仓位更大 → 反弹时盈利更多
2. 风险区自动减买增卖 → 避免接飞刀
3. 因子过滤阻止强下跌买入 → 避免左尾风险
4. 卖单限制保证配对 → 盈利稳定

---

**代码版本**: 2025-12-21
**测试验证**: 1009笔交易，92%胜率
