# 网格交易风险控制规格说明（v1）

## 0. 背景与目标

本策略使用高杠杆网格追求 ROE。极端行情（插针/快速深回撤）是常见风险事件。  
现有机制主要“停下单/停加仓”，但在高杠杆下：**只停加仓不足以防爆仓**，因为风险来自“已有库存 + 杠杆 + 价格跳变”。

### 目标

- **正常行情**：尽量不影响网格的 ROE/成交频率（少误触发）。
- **极端行情**：在接近强平前，自动**主动去库存**降低风险暴露。
- **执行方式**：**限价优先**，若超时 **5 根 1mK（5分钟）**仍未完成减仓，则对剩余量 **转 IOC/市价**（成熟做法）。
- **清仓策略**：允许清仓，但**只在红线（爆仓距离/占用率到红线）**触发。

---

## 1. 核心风控原理（行业成熟做法）

用“实时风险状态”做分级，而不是依赖插针形态：

- **占用率 / 暴露度（inv_usage）**：衡量仓位名义价值占可承受容量的比例。越高越危险。
- **未实现亏损率（unrealized_loss_pct）**：衡量风险是否已经在快速兑现。越负越危险。

分级规则采用：**两者取最大风险（任一触发升级）**，避免漏判。

---

## 2. 风险指标定义

### 2.1 inv_usage（仓位占用率）

- position_notional = |holdings_btc| × current_price
- max_capacity = equity × leverage
- inv_usage = position_notional / max_capacity

解释：
- inv_usage ∈ [0, +∞)
- inv_usage 越接近 1，越接近“任何额外波动都可能导致强平”的状态。

### 2.2 unrealized_loss_pct（未实现亏损率）

- unrealized_loss_pct = unrealized_pnl / equity

解释：
- unrealized_pnl 通常为负代表浮亏
- unrealized_loss_pct 越小（越负），风险越大。

---

## 3. 风险分级与阈值（v1）

> 规则：任一指标触发即可进入对应等级；若两个指标分属不同等级，取更高等级。

### 3.1 等级与阈值

- **Normal**
  - inv_usage < 0.65 且 unrealized_loss_pct > -0.10

- **Caution（黄）**
  - inv_usage ≥ 0.65 或 unrealized_loss_pct ≤ -0.10

- **Danger（橙）**
  - inv_usage ≥ 0.75 或 unrealized_loss_pct ≤ -0.18

- **Redline（红）**
  - inv_usage ≥ 0.85 或 unrealized_loss_pct ≤ -0.25

- **Kill（极红）**
  - inv_usage ≥ 0.92 或 unrealized_loss_pct ≤ -0.35

---

## 4. 每级动作（行为规范）

### 4.1 共识原则

1. **去风险优先级高于做市**：风险越高，越优先“减仓/去库存”，其次才是赚 spread。
2. **卖出/减仓不应被节流/库存限制拦住**：减仓属于风险控制动作，是“紧急通道”。
3. **限价优先，超时转 IOC/市价**：既要尽量少滑点，也要确保在红线时能成交保命。
4. **清仓仅在红线（Redline/Kill）允许**：平时不随意清仓，避免影响 ROE。

---

## 5. 动作细则（v1）

### 5.1 Normal

- 正常网格运行（bid/ask 正常）。
- 不触发任何额外去库存动作。

### 5.2 Caution（黄）：做市式去风险（不硬平）

目的：减少继续滚仓的概率，同时让库存自然回落。

- **只减不加（优先）**：
  - 明显削弱/暂停 bid（禁止或强烈降低买入开仓强度）
  - 保留 ask（允许卖出回收资金）
- **扩大 spread**：
  - 买入更保守、卖出更积极（通过挂单距离/层数/强度实现）
- 不进行强制平仓。

### 5.3 Danger（橙）：温和主动减仓（限价）

目的：库存开始偏高或浮亏开始显著时，主动降低暴露。

- 延续黄区所有动作（只减不加 + 扩大 spread）
- **主动减仓（限价优先）**：
  - 建议减仓比例：20% 当前仓位（可作为初始默认，后续可调参）
  - 仅限价，不触发 IOC/市价兜底（避免过度影响 ROE）

> 注：橙区仍以“做市式去风险”为主，不做硬切换。

### 5.4 Redline（红）：强制去库存（限价→5分钟超时→IOC/市价）

目的：接近强平时必须快速把 inv_usage 拉回安全区，防止插针/深回撤爆仓。

- **强制减仓到安全占用率目标**：
  - 目标：将 inv_usage 拉回 ≤ 0.75（回到橙/黄区附近）
  - 计算需减仓量 Δpos，使得减仓后满足目标 inv_usage
- **执行方式：限价优先**
  - 先下减仓限价单（价格略偏向成交的“主动限价”）
- **超时规则**
  - 若 **5 根 1mK（5分钟）**内未完成目标减仓：
    - 对剩余未完成减仓量，改用 **IOC/市价**（回测中用 close 成交模拟）
- **bid 行为**
  - 禁止/强烈削弱 bid（避免继续加仓）

### 5.5 Kill（极红）：允许清仓（限价→5分钟超时→IOC/市价）

目的：极端情况下把爆仓风险降到最低（允许全平）。

- **允许全平**（仅在红线触发）
- 仍然限价优先；若 5 分钟未能完成，则 IOC/市价兜底。
- 触发后进入冷却期（见第 6 节）。

---

## 6. 恢复机制（冷却与渐进恢复）

目的：避免“刚恢复又再次触发”，减少来回反复。

### 6.1 冷却期

- 从 Redline 或 Kill 降级后，不立刻回 Normal：
  - 建议冷却：30–60 分钟（可参数化）
- 冷却期内：
  - bid 逐步恢复（从极弱到正常）
  - spread 逐步收敛（从宽到正常）

### 6.2 分级回退

- 等级回退遵循：Kill → Redline → Danger → Caution → Normal
- 每级至少保持 N 分钟（可参数化），满足稳定条件才允许再降级。

---

## 7. 执行建模（回测简化口径）

你确认采用：
- **市价模拟 = 当根 1m bar 的 close 成交**（卖出/买入均用 close）

限价是否成交：
- 可用 “high/low 穿越限价” 判断成交（若价格触达则成交，否则未成交）。

超时：
- 以 bar 计数：5 根 1m bar。

---

## 8. 关键讨论点（后续可迭代）

1. 阈值可再基于不同市场环境（高波动/低波动）做动态化。
2. 危险等级下“减仓比例”和“目标 inv_usage”可用回测压测校准。
3. 是否引入“快速下跌速度阈值”（例如 5 分钟跌幅）作为额外升级条件（v2 可讨论）。

---

## 9. 本版本决策汇总（已确认）

- 超时：**5 根 1mK（5分钟）**
- 红线规则：**inv_usage 与 unrealized_loss_pct 任一触发升级（取最大风险）**
- 清仓：**允许，但仅在红线（Redline/Kill）触发**
- 执行：**限价优先，超时转 IOC/市价**
- 市价模拟：**用当根 bar close 成交**


