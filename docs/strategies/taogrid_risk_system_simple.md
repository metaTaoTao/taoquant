# TaoGrid 风险管理体系（极简版）

**代码位置**: `algorithms/taogrid/helpers/grid_manager.py`

---

## 核心理念

**不用止损，用动态调仓**

- 传统网格：价格跌破就止损
- TaoGrid：价格跌了就少买多卖，跌太多就关网格

---

## 一、网格关闭（熔断机制）

**代码**: `grid_manager.py:1007-1098 check_risk_level()`

满足任意一条，网格立即关闭（停止所有交易）：

### 1. 价格跌太深
```
价格 < 支撑 - 3×ATR
```
例：支撑$92,000，ATR=$500 → 跌破$90,500就关网格

### 2. 浮亏太大
```
未实现亏损 > 30% 权益
```
例：本金$100,000 → 浮亏超过$30,000就关网格

**利润缓冲**：如果之前赚了钱，可以多亏一点
- 公式：阈值 = 30% - (已实现利润 × 50% / 权益)
- 例：赚了$10,000 → 阈值变成35%，可以多亏$5,000

### 3. 库存太满
```
持仓名义价值 > 80% × (权益 × 杠杆)
```
例：本金$100,000，杠杆5x → 持仓超过$400,000就关网格

### 自动恢复
风险条件改善后，网格**自动重新开启**（不需要手动操作）

---

## 二、MM风险区（分级减仓）

**代码**: `grid_manager.py:610-627, 771-783`

价格跌破支撑后，不是立即关网格，而是分3级渐进应对：

### Level 1：轻度风险
**触发**: 价格 < 支撑 + 缓冲（cushion）

**调整**:
- **买单减少到20%** 正常大小（少买，不接飞刀）
- **卖单增加到300%** 正常大小（多卖，快速减仓）

**额外惩罚**: 如果持仓已经超过50%容量 → 买单再减50%

### Level 2：中度风险（预留功能）
**触发**: 在风险区停留较长时间

**调整**:
- 买单减少到10%
- 卖单增加到400%

### Level 3：严重风险
**触发**: 价格 < 支撑 - 2×ATR

**调整**:
- **买单减少到5%**（几乎停买）
- **卖单增加到500%**（疯狂卖出）

---

## 三、因子过滤（阻止买入）

**代码**: `grid_manager.py:628-732`

这些因子会**在下单前检查**，符合条件就减少或阻止买单：

### 1. 趋势因子（避免接飞刀）
**目的**: 强下跌趋势不买入

**逻辑**:
- 趋势得分 ≤ -80% → **完全阻止买入**
- 趋势得分在-80%到0之间 → 减少买入（最多减到50%）

### 2. 突破风险因子（边界保护）
**目的**: 接近区间边界时降低风险

**逻辑**:
- 向下突破风险 ≥ 90% → **完全阻止买入**
- 风险在0-90%之间 → 减少买入（最多减到40%）

### 3. 资金费率因子（省钱）
**目的**: 资金费率为正时减少多单（因为要付钱）

**逻辑**:
- 资金费率 ≥ 0.05% → **完全阻止买入**
- 资金费率在0-0.05%之间 → 减少买入（最多减到40%）
- **只在结算前后±60分钟应用**（避免过度减少交易）

### 4. 区间位置因子（顶部减仓）
**目的**: 接近区间顶部时，少买多卖

**逻辑**:
- 价格在区间45%以上 → 开始减少买入
- 价格越接近100%（阻力位） → 买入减少越多（最多减到20%）
- 同时增加卖出（最多增加到150%）

### 5. 波动率因子（极端行情）
**目的**: 极端高波动时优先卖出减仓

**逻辑**:
- 波动率 ≥ 98%分位数 → 卖出增加到115%
- **默认不应用于买入**（避免减少交易频率）

---

## 四、库存限制

**代码**: `grid_manager.py:589-608`

### 硬阻止
```
库存比例 >= 容量阈值 → 阻止买入
```
- 容量阈值默认90% × 杠杆
- 例：杠杆5x，阈值90% → 持仓超过4.5倍本金就不能再买

### 软减少
库存比例逐渐接近阈值时，渐进减少买单大小（避免硬阻止）

---

## 五、卖单限制（Bug修复）

**代码**: `grid_manager.py:785-806`

**目的**: 防止卖单放大导致错误配对

**逻辑**:
1. 计算对应买单的总大小
2. 限制卖单大小 ≤ 对应买单大小
3. 确保网格配对正确性（buy[i] → sell[i]）

**为什么需要**:
- 卖单经过多个因子放大（MM风险区3-5x，Funding 1-2x，Range 1-1.5x）
- 如果不限制，单个卖单可能卖掉多个买单的仓位 → 触发FIFO fallback → 错误配对

---

## 六、风险管理流程

```
每次下单前检查：
  ↓
1. 计算风险等级
   - Level 0：正常（支撑上方）
   - Level 1：轻度风险（支撑下方）
   - Level 3：严重风险（支撑-2×ATR下方）
   - Level 4：关闭网格（支撑-3×ATR下方或浮亏>30%或库存>80%）
  ↓
2. 应用MM风险区调整（如果在风险区）
   - 买单减少到5-20%
   - 卖单增加到300-500%
  ↓
3. 应用因子过滤（买单）
   - 趋势因子 → 可能阻止买入
   - 突破风险 → 可能阻止买入
   - 资金费率 → 可能阻止买入
   - 区间位置 → 减少买入
  ↓
4. 应用因子放大（卖单）
   - 资金费率 → 增加卖出1-2x
   - 区间位置 → 增加卖出1-1.5x
   - 波动率 → 增加卖出1.15x
  ↓
5. 限制卖单大小到对应买单（防止错误配对）
  ↓
6. 检查库存限制
   - 库存超限 → 阻止买入
  ↓
7. 执行订单
```

---

## 关键参数表

| 参数 | 默认值 | 含义 |
|------|--------|------|
| **网格关闭** | | |
| max_risk_atr_mult | 3.0 | 支撑-3×ATR关闭网格 |
| max_risk_loss_pct | 0.30 | 浮亏30%关闭网格 |
| max_risk_inventory_pct | 0.8 | 库存80%关闭网格 |
| profit_buffer_ratio | 0.5 | 50%利润可缓冲风险 |
| **MM风险区** | | |
| mm_risk_level1_buy_mult | 0.2 | Level 1买20% |
| mm_risk_level1_sell_mult | 3.0 | Level 1卖300% |
| mm_risk_level3_buy_mult | 0.05 | Level 3买5% |
| mm_risk_level3_sell_mult | 5.0 | Level 3卖500% |
| **因子过滤** | | |
| trend_block_threshold | 0.80 | 趋势≤-80%阻止买入 |
| breakout_block_threshold | 0.95 | 突破风险≥95%阻止买入 |
| funding_block_threshold | 0.0005 | 资金费率≥0.05%阻止买入 |

---

## 与市面网格的区别

| 特性 | 普通网格 | TaoGrid |
|------|---------|---------|
| 风险控制 | 止损 | 分级动态调仓 |
| 应对下跌 | 强制平仓 | 少买多卖（3-5倍） |
| 恢复机制 | 手动重开 | 自动恢复 |
| 仓位调整 | 固定大小 | 多因子动态调整 |
| 配对保证 | 无 | 卖单限制到买单大小 |

---

**代码版本**: 2025-12-21
**测试验证**: 84%配对正确率，Sharpe 5.94
