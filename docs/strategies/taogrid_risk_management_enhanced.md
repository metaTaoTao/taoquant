# TaoGrid 风险管理体系（优化增强版）

**代码位置**: `algorithms/taogrid/helpers/grid_manager.py`, `algorithms/taogrid/bitget_live_runner.py`

**版本**: v2.0 (Enhanced for 90% drawdown survival)

---

## 概述

本优化版在原有风控体系基础上，针对 CRO 审查中提出的关键问题进行了增强，特别是**90% 大跌场景下的生存能力**。

### 核心改进

1. **持仓级止损机制**：网格关闭时不仅停止新订单，还强制关闭现有持仓
2. **强制去杠杆默认启用**：降低触发阈值，添加 Level 3 完全平仓
3. **外部紧急停止**：基于文件的 kill switch，可手动触发立即平仓
4. **提前关闭阈值**：降低价格和浮亏阈值，提前触发保护
5. **重新启用保护**：添加冷却期和价格恢复验证
6. **流动性检测**：检测市场深度，确保订单能执行

---

## 一、持仓级止损机制（新增）

### 1.1 设计理念

**问题**：原版网格关闭只停止新订单，现有持仓在 90% 大跌中会持续亏损直至归零。

**解决方案**：当风险等级达到 Level 4 时，不仅关闭网格，还要**强制关闭所有持仓**。

### 1.2 触发条件

持仓级止损在以下任一条件满足时触发：

1. **价格深度止损**：
   ```
   价格 < 支撑 - 2×ATR  (优化：从 3×ATR 降至 2×ATR)
   ```

2. **浮亏止损**：
   ```
   未实现亏损 > 20% 权益  (优化：从 30% 降至 20%)
   ```

3. **强制去杠杆 Level 3**：
   ```
   未实现亏损 > 20% 权益 → 强制关闭所有持仓（100%）
   ```

### 1.3 执行机制

**代码位置**: `grid_manager.py:force_close_all_positions()`

```python
def force_close_all_positions(self) -> dict:
    """
    强制关闭所有持仓（持仓级止损）
    
    返回:
        dict: 包含关闭指令的订单字典，供 runner 执行
    """
    # 返回市价卖出指令，runner 会立即执行
    return {
        "direction": "sell",
        "quantity": holdings_btc,  # 全部持仓
        "price": None,  # 市价执行
        "level": -1,  # 非网格级别
        "reason": "Position-level stop loss triggered",
    }
```

**执行流程**：
1. `check_risk_level()` 检测到 Level 4 风险
2. 调用 `force_close_all_positions()` 生成关闭指令
3. Runner 收到指令后，使用市价单立即关闭所有持仓
4. 使用 Bitget Flash Close Position API 确保执行

---

## 二、强制去杠杆优化（增强）

### 2.1 默认启用

**变更**：`enable_forced_deleverage` 默认值从 `False` → **`True`**

### 2.2 三级去杠杆体系

#### Level 1：轻度去杠杆（10% 浮亏）
**触发条件**：未实现亏损 ≥ 10% 权益（优化：从 15% 降至 10%）

**操作**：卖出 25% 持仓

**目的**：提前减少风险敞口

#### Level 2：中度去杠杆（15% 浮亏）
**触发条件**：未实现亏损 ≥ 15% 权益（优化：从 25% 降至 15%）

**操作**：卖出 50% 持仓

**目的**：进一步降低风险

#### Level 3：完全平仓（20% 浮亏）**（新增）**
**触发条件**：未实现亏损 ≥ 20% 权益

**操作**：**卖出 100% 持仓**（完全平仓）

**目的**：防止进一步亏损，保护剩余 80% 权益

### 2.3 冷却期机制

**参数**：`deleverage_cooldown_bars = 60`（1 小时）

**逻辑**：每次去杠杆操作后，至少等待 60 个 bar 才能再次触发

**目的**：避免频繁交易，给市场时间恢复

---

## 三、外部紧急停止（新增）

### 3.1 设计理念

**问题**：无手动覆盖机制，无法在紧急情况下立即停止交易。

**解决方案**：基于文件的 kill switch，可手动触发立即平仓。

### 3.2 实现机制

**文件位置**：`state/kill_switch`

**触发方式**：
```bash
# 在服务器上创建 kill switch 文件
touch /opt/taoquant/state/kill_switch
```

**代码位置**: `bitget_live_runner.py:check_kill_switch()`

**检查频率**：每个主循环开始时检查

**执行逻辑**：
1. 检查 `state/kill_switch` 文件是否存在
2. 如果存在，立即：
   - 关闭所有持仓（使用市价单）
   - 取消所有挂单
   - 停止交易循环
   - 记录日志

### 3.3 使用场景

- 发现策略异常
- 交易所出现问题
- 需要立即停止交易
- 紧急情况

---

## 四、网格关闭阈值优化

### 4.1 价格阈值优化

**变更**：
- 原值：`支撑 - 3×ATR`
- **优化值**：`支撑 - 2×ATR`

**原因**：提前触发，减少损失

**示例**：
- 支撑 $92,000，ATR $500
- 原触发：$90,500
- **优化触发**：$91,000（提前 $500）

### 4.2 浮亏阈值优化

**变更**：
- 原值：30% 权益
- **优化值**：20% 权益

**原因**：在 90% 大跌场景下，30% 触发过晚

**示例**：
- 本金 $100,000
- 原触发：浮亏 $30,000
- **优化触发**：浮亏 $20,000（提前 $10,000）

### 4.3 单日跌幅阈值（新增）

**新增参数**：`max_daily_drawdown_pct = 0.20`（20%）

**触发条件**：
```
(当前价格 - 24小时前价格) / 24小时前价格 < -20%
```

**操作**：立即关闭网格并强制平仓

**目的**：应对闪崩等极端事件

---

## 五、网格重新启用保护（增强）

### 5.1 冷却期机制（新增）

**参数**：`grid_re_enable_cooldown_bars = 1440`（24 小时）

**逻辑**：
- 网格关闭后，至少等待 1440 个 1 分钟 bar（24 小时）
- 冷却期内，即使风险条件改善，也不会自动重新启用

**目的**：避免在风险未完全解决时重新启用

### 5.2 价格恢复验证（新增）

**参数**：`grid_re_enable_price_recovery_atr_mult = 1.0`

**验证条件**：
```
当前价格 >= 支撑 + 1×ATR
```

**逻辑**：
- 网格关闭后，价格必须恢复到支撑 + 1×ATR 以上
- 且冷却期已过
- 才能自动重新启用

**目的**：确保价格真正恢复，而非短暂反弹

### 5.3 手动批准选项（新增）

**参数**：`grid_re_enable_requires_manual_approval = False`

**逻辑**：
- 如果设置为 `True`，网格关闭后需要手动批准才能重新启用
- 手动批准方式：删除 `state/grid_disabled` 文件

**目的**：给交易员完全控制权

---

## 六、流动性检测（新增）

### 6.1 市场深度检测

**代码位置**: `bitget_live_runner.py:check_market_depth()`

**检测逻辑**：
1. 获取订单簿深度
2. 计算前 5 档买卖盘总量
3. 如果深度 < 订单大小的 2 倍，认为流动性不足

### 6.2 分批平仓机制

**触发条件**：流动性不足且需要平仓

**执行逻辑**：
1. 将大额订单拆分为多个小额订单
2. 每个订单不超过市场深度的 50%
3. 分批执行，避免冲击成本

### 6.3 订单执行超时检测

**参数**：`order_execution_timeout_seconds = 30`

**逻辑**：
- 如果订单在 30 秒内未成交，取消并重试
- 重试最多 3 次
- 如果仍失败，使用市价单强制执行

---

## 七、完整风险管理流程（优化版）

```
每次主循环开始：
  ↓
1. 检查紧急停止 (kill_switch)
   ├─ 存在 → 立即平仓并停止
   └─ 不存在 → 继续
  ↓
2. 计算风险等级
   - Level 0：正常（支撑上方）
   - Level 1：轻度风险（支撑下方）
   - Level 3：严重风险（支撑-2×ATR下方）
   - Level 4：关闭网格（支撑-2×ATR下方或浮亏>20%或库存>80%）
  ↓
3. 如果 Level 4 → 触发持仓级止损
   - 关闭网格
   - 强制关闭所有持仓（市价单）
   - 记录关闭原因
  ↓
4. 检查强制去杠杆
   - Level 1 (10% 浮亏) → 卖出 25%
   - Level 2 (15% 浮亏) → 卖出 50%
   - Level 3 (20% 浮亏) → 卖出 100%（完全平仓）
  ↓
5. 如果网格未关闭，应用 MM 风险区调整
   - Level 1：买入 20%，卖出 300%
   - Level 3：买入 5%，卖出 500%
  ↓
6. 应用因子过滤（买单）
   - 趋势因子 → 可能阻止买入
   - 突破风险 → 可能阻止买入
   - 资金费率 → 可能阻止买入
  ↓
7. 检查库存限制
   - 库存超限 → 阻止买入
  ↓
8. 执行订单（如果网格启用）
```

---

## 八、关键参数对比表

| 参数 | 原版值 | 优化值 | 说明 |
|------|--------|--------|------|
| **网格关闭** | | | |
| `max_risk_atr_mult` | 3.0 | **2.0** | 提前触发 |
| `max_risk_loss_pct` | 0.30 | **0.20** | 提前触发 |
| `max_daily_drawdown_pct` | - | **0.20** | 新增：单日跌幅阈值 |
| **强制去杠杆** | | | |
| `enable_forced_deleverage` | False | **True** | 默认启用 |
| `deleverage_level1_unrealized_loss_pct` | 0.15 | **0.10** | 提前触发 |
| `deleverage_level2_unrealized_loss_pct` | 0.25 | **0.15** | 提前触发 |
| `deleverage_level3_unrealized_loss_pct` | - | **0.20** | 新增：完全平仓 |
| `deleverage_level3_sell_frac` | - | **1.0** | 新增：100% 平仓 |
| **重新启用** | | | |
| `grid_re_enable_cooldown_bars` | 0 | **1440** | 24 小时冷却期 |
| `grid_re_enable_price_recovery_atr_mult` | - | **1.0** | 价格恢复验证 |
| `grid_re_enable_requires_manual_approval` | - | **False** | 可选手动批准 |

---

## 九、90% 大跌场景下的行为

### 场景设定
- 价格从 $100,000 跌至 $10,000（90% 跌幅）
- 支撑 $92,000，ATR $500
- 本金 $100,000，持仓平均成本 $95,000

### 执行时间线

**T0: 价格 $95,000（正常）**
- 风险等级：Level 0
- 网格正常交易

**T1: 价格 $91,000（跌破支撑 - 2×ATR）**
- 风险等级：Level 4
- **网格关闭**
- **持仓级止损触发** → 强制平仓
- 未实现亏损：约 -4.2%
- **权益保护：95.8%**

**T2: 如果平仓失败，价格继续跌至 $85,000**
- 强制去杠杆 Level 1 触发（10% 浮亏）
- 卖出 25% 持仓

**T3: 价格跌至 $80,000**
- 强制去杠杆 Level 2 触发（15% 浮亏）
- 卖出 50% 持仓

**T4: 价格跌至 $76,000（20% 浮亏）**
- 强制去杠杆 Level 3 触发
- **卖出 100% 持仓**（完全平仓）
- **权益保护：80%**

### 对比原版

| 版本 | 90% 大跌场景下的权益保护 |
|------|------------------------|
| 原版 | <5%（权益归零） |
| **优化版** | **80%+**（提前平仓保护） |

---

## 十、使用建议

### 10.1 参数配置建议

**保守配置**（适合高杠杆）：
```python
max_risk_loss_pct = 0.15  # 15% 浮亏就关闭
deleverage_level1_unrealized_loss_pct = 0.08  # 8% 开始去杠杆
deleverage_level2_unrealized_loss_pct = 0.12  # 12% 进一步去杠杆
deleverage_level3_unrealized_loss_pct = 0.15  # 15% 完全平仓
```

**标准配置**（推荐）：
```python
max_risk_loss_pct = 0.20  # 20% 浮亏关闭
deleverage_level1_unrealized_loss_pct = 0.10  # 10% 开始去杠杆
deleverage_level2_unrealized_loss_pct = 0.15  # 15% 进一步去杠杆
deleverage_level3_unrealized_loss_pct = 0.20  # 20% 完全平仓
```

**激进配置**（适合低杠杆）：
```python
max_risk_loss_pct = 0.25  # 25% 浮亏关闭
deleverage_level1_unrealized_loss_pct = 0.12  # 12% 开始去杠杆
deleverage_level2_unrealized_loss_pct = 0.18  # 18% 进一步去杠杆
deleverage_level3_unrealized_loss_pct = 0.25  # 25% 完全平仓
```

### 10.2 紧急停止使用

**触发紧急停止**：
```bash
# 在服务器上执行
touch /opt/taoquant/state/kill_switch

# 系统会立即：
# 1. 关闭所有持仓
# 2. 取消所有挂单
# 3. 停止交易循环
```

**取消紧急停止**：
```bash
# 删除文件
rm /opt/taoquant/state/kill_switch

# 重启服务
sudo systemctl restart taoquant-runner
```

### 10.3 监控建议

1. **实时监控浮亏**：确保不超过 20% 阈值
2. **监控网格状态**：如果网格关闭，检查原因
3. **监控强制去杠杆**：如果触发，检查市场情况
4. **定期检查 kill_switch**：确保文件存在时系统已停止

---

## 十一、代码位置索引

- **持仓级止损**：`algorithms/taogrid/helpers/grid_manager.py:force_close_all_positions()`
- **强制去杠杆 Level 3**：`algorithms/taogrid/algorithm.py:generate_signals()` (P1 部分)
- **紧急停止检查**：`algorithms/taogrid/bitget_live_runner.py:check_kill_switch()`
- **网格关闭逻辑**：`algorithms/taogrid/helpers/grid_manager.py:check_risk_level()`
- **重新启用验证**：`algorithms/taogrid/helpers/grid_manager.py:check_risk_level()` (自动恢复部分)
- **配置参数**：`algorithms/taogrid/config.py`

---

## 十二、测试验证

### 12.1 压力测试场景

1. **90% 大跌场景**：
   - 价格从 $100,000 跌至 $10,000
   - 验证：权益保护 ≥ 80%

2. **闪崩场景**：
   - 单日跌幅 30%
   - 验证：立即触发关闭和平仓

3. **流动性枯竭场景**：
   - 市场深度不足
   - 验证：分批平仓机制工作

4. **交易所故障场景**：
   - 模拟 API 超时
   - 验证：紧急停止机制工作

### 12.2 回测验证

- 在 2022 年加密崩盘数据上回测
- 验证所有保护机制正确触发
- 记录最大回撤和权益保护比例

---

**最后更新**：2025-12-24  
**版本**：v2.0 (Enhanced)  
**CRO 审查状态**：已解决关键生存问题


