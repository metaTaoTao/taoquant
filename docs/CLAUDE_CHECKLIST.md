# CLAUDE.md 遵循检查清单

**用途**: 在每次开发新策略或修改代码前，快速检查是否遵循 `CLAUDE.md` 规则。

**优先级顺序**（必须按此顺序检查）:
1. ✅ 架构合规性（最高优先级）
2. ✅ CLAUDE.md 规则
3. ✅ 纯函数与可复现性
4. ✅ 类型安全与模块化
5. ✅ 策略逻辑保真度
6. ✅ 清晰的推理说明

---

## 🏗️ 架构合规性检查

- [ ] **文件位置正确**：文件放在正确的层级目录中
  - 指标 → `analytics/indicators/<name>.py`
  - 策略 → `strategies/signal_based/<name>.py`
  - 引擎 → `execution/engines/<name>.py`
  - 数据源 → `data/sources/<name>.py`

- [ ] **层级边界未破坏**：
  - [ ] 策略中**没有**数据获取（应通过 `compute_indicators(data)` 传入）
  - [ ] 指标中**没有**数据获取（纯函数，只处理输入数据）
  - [ ] 策略中**没有**回测执行逻辑（只生成信号）
  - [ ] 数据层**没有**策略逻辑

- [ ] **依赖方向正确**：依赖只能向下（上层依赖下层），不能向上

---

## 📋 CLAUDE.md 规则检查

- [ ] **策略继承 BaseStrategy**：所有策略继承 `BaseStrategy`
- [ ] **实现三个方法**：
  - [ ] `compute_indicators(data) -> DataFrame`
  - [ ] `generate_signals(data) -> DataFrame`
  - [ ] `calculate_position_size(data, equity) -> Series`

- [ ] **信号 DataFrame 格式**：
  - [ ] 包含 `entry` (bool)
  - [ ] 包含 `exit` (bool)
  - [ ] 包含 `direction` (str: 'long' or 'short')
  - [ ] 包含 `reason` (str, optional)

- [ ] **指标是纯函数**：
  - [ ] 无副作用（不修改全局状态）
  - [ ] 无隐藏状态（相同输入 → 相同输出）
  - [ ] 不获取数据（数据通过参数传入）

---

## 🔬 纯函数与可复现性

- [ ] **指标函数**：
  - [ ] 是顶层函数（不是类方法，除非必要）
  - [ ] 有完整的类型提示
  - [ ] 有文档字符串
  - [ ] 不修改输入数据（使用 `.copy()` 或 `.assign()`）

- [ ] **信号生成**：
  - [ ] 使用向量化操作（pandas，避免 Python 循环）
  - [ ] 无随机性（除非明确需要）
  - [ ] 处理 NaN 值

---

## 🔒 类型安全与模块化

- [ ] **所有函数有类型提示**：
  - [ ] 参数类型
  - [ ] 返回类型
  - [ ] 使用 `from __future__ import annotations`

- [ ] **配置使用 dataclass**：
  - [ ] 继承 `StrategyConfig`
  - [ ] 有 `name` 和 `description`
  - [ ] 有 `__post_init__` 验证（如需要）

- [ ] **模块化设计**：
  - [ ] 函数职责单一
  - [ ] 可组合（函数可以组合使用）
  - [ ] 无循环依赖

---

## 📺 TradingView 转换检查（如适用）

- [ ] **逻辑保真度**：
  - [ ] 没有简化掉原 Pine Script 逻辑
  - [ ] 多时间框架处理正确（4H → 15m 对齐）
  - [ ] 参数含义与原脚本一致

- [ ] **映射正确**：
  - [ ] Pine 指标部分 → `analytics/indicators/`
  - [ ] Pine 入场/出场条件 → `generate_signals()`
  - [ ] Pine 止损/止盈 → `calculate_position_size()` + position manager

---

## 📝 代码质量

- [ ] **文档字符串**：
  - [ ] Google 风格
  - [ ] 说明参数和返回值
  - [ ] 包含使用示例（如适用）

- [ ] **注释**：
  - [ ] 英文注释
  - [ ] 代码中无 emoji
  - [ ] 复杂逻辑有解释

- [ ] **错误处理**：
  - [ ] 验证输入数据
  - [ ] 有意义的错误消息
  - [ ] 处理边界情况（NaN, 空数据等）

---

## 🧪 测试与调试

- [ ] **提供了使用示例**：
  - [ ] 如何初始化策略
  - [ ] 如何运行回测
  - [ ] 预期输出说明

- [ ] **调试支持**：
  - [ ] 可操作的调试步骤（不是"应该能工作"）
  - [ ] 如需要，添加了临时调试列
  - [ ] 考虑了边界情况

---

## ✅ 最终确认

- [ ] **已阅读 CLAUDE.md** 相关章节
- [ ] **已检查架构合规性**（优先级 1）
- [ ] **代码符合所有规则**
- [ ] **已提供使用示例和说明**

---

**如果任何检查项失败，请：**
1. 停止并重新审视设计
2. 参考 `CLAUDE.md` 相关章节
3. 参考 `docs/system_design.md` 架构说明
4. 如需要，在对话中明确说明为什么需要偏离规则

