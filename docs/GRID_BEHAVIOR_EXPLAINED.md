# 网格策略行为说明

## 📊 你看到的情况分析

**现象**：
- 当前价格：89,595.6
- 网格买单：88,857, 88,715, 88,574, 88,432, 88,291（都在88K附近）
- 网格卖单：0个（planned_sell=0）

**这是预期的吗？** ✅ **是的，这是正常行为！**

---

## 🔍 原因分析

### 1. 网格是基于固定区间生成的

网格策略使用固定的 **support/resistance** 区间来生成网格层级：

```python
# 从你的config_bitget_live.json可以看到：
{
  "strategy": {
    "support": 84000.0,
    "resistance": 94000.0,
    ...
  }
}
```

网格层级在**初始化时一次性生成**，基于这个固定区间。

### 2. 卖单的生成逻辑

**关键代码** (`bitget_live_runner.py` 747-752行)：
```python
# 只显示在当前价格上方的卖单（避免立即成交）
if direction == "sell" and price < current_price:
    continue  # 跳过卖单如果价格低于当前价
```

**你的情况**：
- 当前价格：89,595.6
- 如果网格的 `resistance` 设置在 ~89K 左右
- 所有 `sell_levels` 都在 89,595 下方（例如：88,964, 89,024, 89,084...）
- **结果**：所有卖单都被过滤掉，因为它们在当前价格下方

### 3. 买单在88K是正常的

买单应该在**当前价格下方**等待回调：
- 当前价格：89,595.6
- 买单价格：88,857, 88,715...
- ✅ 这是正确的！买单应该低于当前价

---

## 💡 这代表什么？

### 情况1: 价格已经突破网格上限

如果当前价格（89.6K）已经接近或超过了你设置的 `resistance`（94K），说明：

1. **网格设计合理**：你的网格区间是 84K-94K
2. **价格突破了预期范围**：当前价格在区间上半部分
3. **卖单应该存在**，但可能在当前价格附近被过滤

### 情况2: 需要检查配置

检查你的 `config_bitget_live.json`：

```json
{
  "strategy": {
    "support": 84000.0,    // 你的支撑位
    "resistance": 94000.0,  // 你的阻力位
    ...
  }
}
```

**如果当前价格是89.6K**：
- 价格在 84K-94K 区间内 ✅
- 应该有一些卖单在上方（接近94K）
- 如果没有卖单，可能是：
  1. 卖单层级都在89.6K下方（配置问题）
  2. 或者有持仓，卖单被其他逻辑过滤了

---

## 🔧 如何验证和调整

### 1. 查看完整的网格信息

在日志初始化时应该看到网格信息，类似：
```
Grid Configuration:
  support: $84,000
  resistance: $94,000
  buy_levels: 40
  sell_levels: 40
  buy_range: $84,000 - $88,857
  sell_range: $88,964 - $94,000  # 检查这个范围
```

### 2. 检查卖单层级

如果卖单范围最高只有 ~89K，而当前价格是 89.6K，那么：
- 所有卖单都会被过滤（因为都在当前价下方）
- **这是正常的过滤行为**（避免立即成交）

### 3. 调整配置（如果需要）

如果价格经常超出你的网格范围，考虑：

**选项A: 扩大网格范围**
```json
{
  "strategy": {
    "support": 80000.0,   // 降低支撑
    "resistance": 100000.0, // 提高阻力
    ...
  }
}
```

**选项B: 启用Mid-Shift（动态调整）**
```json
{
  "strategy": {
    "enable_mid_shift": true,  // 允许网格中心动态调整
    ...
  }
}
```

---

## ⚠️ 重要理解

### 网格策略的特点

1. **固定区间策略**
   - 网格基于固定区间设计
   - 适合震荡行情
   - 不适合趋势行情（会突破区间）

2. **买单在下，卖单在上**
   - 买单：在当前价格**下方**等待回调
   - 卖单：在当前价格**上方**等待上涨
   - 这是正常的网格行为

3. **订单过滤逻辑**
   - 只显示"合理的"订单（不会立即成交的）
   - 买单：只显示 price ≤ current_price
   - 卖单：只显示 price ≥ current_price
   - **避免立即成为taker订单**

### 你的情况

**当前价格89.6K，买单在88K**：
- ✅ 完全正常
- 买单在下方等待价格回调

**没有卖单显示**：
- 可能是因为所有sell_levels都在89.6K下方
- 或者有持仓，卖单逻辑不同
- **这是过滤后的结果，不是bug**

---

## 🎯 建议

### 对于Dry Run测试

1. **观察一段时间**（至少几小时）
   - 看看价格是否会回调到88K附近
   - 如果回调，买单会被触发

2. **检查配置是否合理**
   - support/resistance 是否覆盖当前价格波动范围
   - 如果价格经常超出范围，考虑调整

3. **验证卖单逻辑**
   - 如果有持仓，应该会有对应的卖单
   - 检查日志中是否有 `[GRID]` 相关信息

### 如果价格持续超出范围

如果价格持续在90K以上，而你的网格上限是94K：

1. **当前行为是正常的**
   - 网格在等待价格回到区间内
   - 买单会等待回调

2. **考虑调整策略**
   - 扩大网格范围
   - 或者等待价格回到区间内再运行

---

## 📝 总结

**你看到的情况是预期的！**

- ✅ 买单在88K（在当前价下方）是正确的
- ✅ 没有卖单可能是因为：
  1. 卖单层级都在当前价下方（被过滤）
  2. 或者没有持仓（网格策略只在有持仓时生成卖单）

**这不是bug，而是网格策略的正常过滤行为。**

如果担心，可以：
1. 检查日志中的网格初始化信息
2. 确认 support/resistance 配置是否合理
3. 观察更长时间，看价格是否会回到网格区间

---

最后更新: 2025-12-22

