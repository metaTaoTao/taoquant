"""
分析为什么延长回测时间后交易次数反而减少
"""
import sys
from pathlib import Path

project_root = Path(__file__).parent.parent
sys.path.insert(0, str(project_root))

print("=" * 80)
print("分析：为什么延长回测时间后交易次数反而减少？")
print("=" * 80)

print("\n时间范围对比：")
print("  原回测：2025-09-26 至 2025-10-26 (30天)")
print("  新回测：2025-07-10 至 2025-10-26 (108天)")
print("  延长了：78天 (2.6倍)")

print("\n" + "=" * 80)
print("可能的原因分析")
print("=" * 80)

possible_reasons = """
1. 【价格在网格范围外的时间更长】
   
   网格范围：107K - 123K
   
   如果7.10-9.26期间价格：
   - 一直在网格范围外（低于107K或高于123K）
   - 或者价格波动很小，没有触发网格订单
   - 那么这段时间就不会有交易
   
   检查方法：查看7.10-9.26期间的价格范围

2. 【网格在某个时间点被关闭，之后没有重新启用】
   
   代码逻辑（grid_manager.py:979-985）：
   - 如果 enable_mm_risk_zone = False，不会自动关闭网格
   - 但您的配置中 enable_mm_risk_zone = False
   - 所以这个原因不太可能
   
   但需要检查：是否有其他关闭网格的逻辑？

3. 【因子过滤在某个时间段内阻止了大部分交易】
   
   可能的情况：
   - 7.10-9.26期间，Breakout Risk 一直很高
   - 或者 Trend Score 一直很低（强下跌趋势）
   - 导致大部分买入订单被阻止
   
   检查方法：查看7.10-9.26期间的因子状态

4. 【库存限制在某个时间段内阻止了买入】
   
   可能的情况：
   - 7.10-9.26期间，库存比率一直接近或超过阈值
   - 导致买入订单被阻止
   - 只有卖出订单在执行，但卖出配对后持仓减少
   - 最终导致交易次数减少
   
   检查方法：查看7.10-9.26期间的库存状态

5. 【数据问题】
   
   可能的情况：
   - 7.10-9.26期间的数据缺失或有问题
   - 导致某些时间段无法正常交易
   
   检查方法：检查数据完整性

6. 【网格初始化问题】
   
   可能的情况：
   - 网格在某个时间点被重置
   - 或者网格层级在某个时间点发生变化
   - 导致订单无法正常触发
   
   检查方法：检查网格初始化逻辑

7. 【价格波动率变化】
   
   可能的情况：
   - 7.10-9.26期间，价格波动率较低
   - 网格间距可能较大，导致订单触发频率降低
   - 或者ATR变化导致网格间距变化
   
   检查方法：查看7.10-9.26期间的ATR和网格间距
"""

print(possible_reasons)

print("\n" + "=" * 80)
print("最可能的原因")
print("=" * 80)

most_likely = """
基于代码逻辑分析，最可能的原因是：

1. 【价格在网格范围外的时间更长】★★★★★
   
   如果7.10-9.26期间价格：
   - 大部分时间在107K以下或123K以上
   - 那么网格订单不会被触发
   - 这段时间就不会有交易
   
   这是最可能的原因，因为：
   - 网格订单是限价单，只在网格范围内触发
   - 如果价格不在网格范围内，订单不会被触发
   - 延长回测时间，如果新增的时间段价格不在网格范围内，交易次数反而会减少

2. 【因子过滤在某个时间段内阻止了大部分交易】★★★★
   
   如果7.10-9.26期间：
   - Breakout Risk 一直很高（>= 0.9）
   - 或者 Trend Score 一直很低（强下跌趋势）
   - 导致大部分买入订单被阻止
   - 只有卖出订单在执行，但卖出配对后持仓减少
   - 最终导致交易次数减少
   
   这是第二可能的原因，因为：
   - 您的配置中启用了多个因子过滤
   - Breakout Risk 和 MR+Trend 都可能阻止买入
   - 如果某个时间段这些因子一直不利，交易次数会大幅减少

3. 【库存限制在某个时间段内阻止了买入】★★★
   
   如果7.10-9.26期间：
   - 库存比率一直接近或超过阈值（50倍权益）
   - 导致买入订单被阻止
   - 只有卖出订单在执行
   - 最终导致交易次数减少
   
   这是第三可能的原因，因为：
   - 您的配置中 inventory_capacity_threshold_pct = 1.0
   - 阈值 = 1.0 * 50 = 50倍权益
   - 如果库存比率一直很高，买入会被持续阻止
"""

print(most_likely)

print("\n" + "=" * 80)
print("建议的检查方法")
print("=" * 80)

suggestions = """
1. 【检查价格范围】
   
   运行以下代码检查7.10-9.26期间的价格范围：
   
   ```python
   from data import DataManager
   import pandas as pd
   
   dm = DataManager()
   data = dm.get_klines('BTCUSDT', '1m', 
                        start=pd.Timestamp('2025-07-10', tz='UTC'),
                        end=pd.Timestamp('2025-09-26', tz='UTC'))
   
   print(f"价格范围: ${data['low'].min():,.0f} - ${data['high'].max():,.0f}")
   print(f"网格范围: $107,000 - $123,000")
   
   # 检查价格在网格范围内的时间比例
   in_range = ((data['low'] >= 107000) & (data['high'] <= 123000)).sum()
   total = len(data)
   print(f"价格在网格范围内的时间: {in_range}/{total} ({in_range/total*100:.1f}%)")
   ```

2. 【检查网格关闭状态】
   
   在回测日志中搜索：
   - "GRID SHUTDOWN"
   - "Grid disabled"
   - 检查是否有长时间关闭的情况

3. 【检查因子状态】
   
   在回测日志中搜索：
   - "Order blocked"
   - "Breakout risk-off"
   - "Factor block"
   - 检查7.10-9.26期间是否有大量订单被阻止

4. 【检查库存状态】
   
   在回测日志中搜索：
   - "Inventory de-risk"
   - "Inventory ratio"
   - 检查7.10-9.26期间库存是否一直很高

5. 【对比两个时间段的交易分布】
   
   分别统计：
   - 7.10-9.26期间的交易次数
   - 9.26-10.26期间的交易次数
   - 对比两个时间段的交易频率
"""

print(suggestions)

print("\n" + "=" * 80)
print("总结")
print("=" * 80)

summary = """
为什么延长回测时间后交易次数反而减少？

最可能的原因：
1. 价格在网格范围外的时间更长（7.10-9.26期间价格可能不在107K-123K范围内）
2. 因子过滤在某个时间段内阻止了大部分交易（Breakout Risk 或 Trend Score 不利）
3. 库存限制在某个时间段内阻止了买入（库存比率一直很高）

建议：
1. 检查7.10-9.26期间的价格范围，确认是否在网格范围内
2. 检查回测日志，查看是否有大量订单被阻止
3. 对比两个时间段的交易分布，找出差异

如果确认是价格范围问题，可以考虑：
- 调整S/R水平以适应更长的回测周期
- 或者分段回测，分别分析不同时间段的表现
"""

print(summary)
