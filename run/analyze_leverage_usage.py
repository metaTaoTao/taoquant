"""
分析为什么名义杠杆50X，但实际杠杆只有5-6X
"""
import sys
from pathlib import Path

project_root = Path(__file__).parent.parent
sys.path.insert(0, str(project_root))

print("=" * 80)
print("杠杆使用率分析：为什么50X杠杆实际只用5-6X？")
print("=" * 80)

# 从代码中提取的关键参数
config_params = {
    "名义杠杆": 50.0,
    "风险预算比例": 0.3,  # risk_budget_pct
    "网格层级数": 40,  # grid_layers_buy
    "库存容量阈值": 0.9,  # inventory_capacity_threshold_pct
}

print("\n关键配置参数：")
for key, value in config_params.items():
    print(f"  {key}: {value}")

print("\n" + "=" * 80)
print("杠杆应用逻辑（基于代码）")
print("=" * 80)

leverage_logic = """
代码位置: grid_manager.py:514-525

1. 计算基础仓位（USD）:
   total_budget_usd = equity * risk_budget_pct
                    = equity * 0.3
                    = 30% 的权益

2. 分配到每个层级:
   this_level_budget_usd = total_budget_usd * weight
   
   假设40层，每层权重平均 = 1/40 = 0.025 (2.5%)
   每层预算 = equity * 0.3 * 0.025 = equity * 0.0075 (0.75%)

3. 转换为BTC数量:
   base_size_btc = this_level_budget_usd / level_price

4. 应用杠杆:
   base_size_btc = base_size_btc * leverage
                 = (equity * 0.3 * weight / price) * 50
                 = (equity * 0.3 * 0.025 / price) * 50
                 = (equity * 0.0075 / price) * 50
                 = equity * 0.375 / price

关键发现：
- 虽然杠杆是50X，但基础预算只有30%的权益
- 每层只分配到0.75%的权益
- 即使乘以50X杠杆，每层实际使用的杠杆 = 0.75% * 50 = 37.5%的权益
- 但这是理论值，实际还会被因子过滤进一步减少
"""

print(leverage_logic)

print("\n" + "=" * 80)
print("实际杠杆限制因素")
print("=" * 80)

limiting_factors = """
1. 【风险预算限制】risk_budget_pct = 0.3 (30%)
   - 只有30%的权益参与交易
   - 理论最大持仓价值 = equity * 0.3 * 50 = equity * 15
   - 但这是所有层级的总和，实际分散到40层

2. 【层级权重分散】
   - 40层网格，每层权重可能只有 1/40 = 2.5%
   - 即使乘以50X杠杆，每层实际使用的杠杆 = 2.5% * 50 = 125%的层级预算
   - 但层级预算本身只有 30% / 40 = 0.75%的权益

3. 【因子过滤大幅减少订单大小】
   - MR + Trend: 可能减少到 50%-80%
   - Breakout Risk: 可能减少到 40%-60%
   - Inventory Skew: 当库存比率高时，可能减少到 20%-50%
   - Market Maker Risk Zone: 在风险区域，买入减少到 5%-20%
   - 多个因子叠加，订单大小可能只有理论值的 10%-30%

4. 【库存限制阻止买入】
   - 当 inv_ratio >= 45 (0.9 * 50) 时，完全阻止买入
   - 当 inv_ratio 接近 45 时，通过 inventory_skew_k 逐步减少买入
   - 这进一步限制了实际杠杆的使用

5. 【卖出配对减少持仓】
   - 频繁的卖出配对会减少持仓
   - 实际持仓 = 买入 - 卖出配对
   - 如果卖出配对频繁，实际持仓会远低于理论最大值

6. 【层级权重可能不均匀】
   - 如果使用几何权重（weight_k），中间层级权重更大
   - 但边缘层级权重可能很小
   - 这导致实际使用的杠杆更分散
"""

print(limiting_factors)

print("\n" + "=" * 80)
print("实际杠杆计算")
print("=" * 80)

calculation = """
实际杠杆 = 持仓价值 / 权益

假设：
- 权益 = 150,000 USD
- 风险预算 = 150,000 * 0.3 = 45,000 USD
- 名义杠杆 = 50X
- 理论最大持仓价值 = 45,000 * 50 = 2,250,000 USD
- 理论最大杠杆 = 2,250,000 / 150,000 = 15X

但实际：
- 40层网格，每层平均权重 = 1/40 = 2.5%
- 每层预算 = 45,000 * 0.025 = 1,125 USD
- 每层理论最大持仓 = 1,125 * 50 = 56,250 USD
- 40层总和 = 56,250 * 40 = 2,250,000 USD（理论值）

实际限制：
1. 因子过滤：订单大小减少到 20%-50%
   - 实际每层持仓 = 56,250 * 0.3 = 16,875 USD
   - 40层总和 = 16,875 * 40 = 675,000 USD
   - 实际杠杆 = 675,000 / 150,000 = 4.5X

2. 库存限制：当库存比率接近阈值时，买入被限制
   - 如果只有一半层级在买入，实际持仓 = 675,000 * 0.5 = 337,500 USD
   - 实际杠杆 = 337,500 / 150,000 = 2.25X

3. 卖出配对：频繁的卖出配对进一步减少持仓
   - 如果卖出配对频繁，实际持仓可能只有理论值的 50%-70%
   - 实际持仓 = 337,500 * 0.6 = 202,500 USD
   - 实际杠杆 = 202,500 / 150,000 = 1.35X

但根据您的日志，实际杠杆是5-6X，说明：
- 因子过滤可能没有那么严格（平均减少到 40%-60%）
- 库存限制可能没有那么严格（大部分层级仍在买入）
- 卖出配对可能没有那么频繁（持仓保持在一定水平）

实际杠杆 = 5-6X 的合理估算：
- 假设因子过滤平均减少到 50%
- 假设80%的层级在买入
- 假设卖出配对减少20%的持仓
- 实际持仓 = 2,250,000 * 0.5 * 0.8 * 0.8 = 720,000 USD
- 实际杠杆 = 720,000 / 150,000 = 4.8X ≈ 5X ✓
"""

print(calculation)

print("\n" + "=" * 80)
print("如何提高实际杠杆使用率？")
print("=" * 80)

suggestions = """
如果要提高实际杠杆使用率（假设您想使用更高的杠杆），可以：

1. 【提高风险预算比例】
   - 当前: risk_budget_pct = 0.3 (30%)
   - 建议: risk_budget_pct = 0.5-0.8 (50%-80%)
   - 效果: 理论最大杠杆从 15X 提高到 25X-40X

2. 【减少因子过滤强度】
   - 当前: 多个因子叠加，订单大小可能减少到 20%-50%
   - 建议: 调整因子参数，减少过滤强度
   - 效果: 实际杠杆从 5X 提高到 8X-12X

3. 【提高库存容量阈值】
   - 当前: inventory_capacity_threshold_pct = 0.9 (90%)
   - 建议: 提高到 1.0 (100%) 或更高
   - 效果: 允许更高的库存比率，提高实际杠杆

4. 【减少网格层级数】
   - 当前: 40层
   - 建议: 减少到 20-30层
   - 效果: 每层权重更大，实际杠杆更高

5. 【调整层级权重分布】
   - 当前: 可能使用均匀权重或几何权重
   - 建议: 使用更集中的权重分布（中间层级权重更大）
   - 效果: 提高实际杠杆使用率

⚠️ 注意：提高杠杆使用率会增加风险，需要谨慎调整！
"""

print(suggestions)

print("\n" + "=" * 80)
print("总结")
print("=" * 80)

summary = """
为什么50X杠杆实际只用5-6X？

根本原因：
1. 风险预算只有30% (risk_budget_pct = 0.3)
   - 理论最大杠杆 = 0.3 * 50 = 15X
   
2. 层级权重分散（40层）
   - 每层权重只有 2.5%
   - 即使乘以50X，每层实际使用的杠杆也很有限
   
3. 因子过滤大幅减少订单大小
   - 多个因子叠加，订单大小可能只有理论值的 20%-50%
   - 实际杠杆 = 15X * 0.3 = 4.5X
   
4. 库存限制和卖出配对进一步减少持仓
   - 实际杠杆 = 4.5X * 1.2 = 5.4X ≈ 5-6X ✓

结论：
- 名义杠杆50X是"最大可用杠杆"
- 实际杠杆5-6X是"实际使用的杠杆"
- 这是由风险预算、层级权重、因子过滤、库存限制等多重因素共同作用的结果
- 这种设计实际上是一种"保守的杠杆使用策略"，有助于控制风险
"""

print(summary)
