# 双回测分析报告

## 回测结果对比

### 交易数量对比

| 时间段 | 总交易数 | 订单触发数 | 订单阻止数 |
|--------|---------|-----------|-----------|
| 7.10-10.26 (108天) | **1179** | 1217 | 3 |
| 9.26-10.26 (30天) | **1274** | 1321 | 3 |
| **差异** | **-95** | -104 | 0 |

**关键发现**：
- 7.10-10.26期间总交易数 **少于** 9.26-10.26期间
- 7.10-9.26期间交易数 = 1179 - 1274 = **-95笔**（不可能！）
- 这说明：**9.26-10.26期间的交易数在7.10-10.26回测中减少了95笔**

### 交易频率对比

| 时间段 | 交易频率 (笔/K线) |
|--------|------------------|
| 7.10-10.26 | 0.0076 |
| 9.26-10.26 | 0.0295 |
| **差异** | **-0.0219** |

**关键发现**：
- 7.10-10.26期间交易频率 **明显低于** 9.26-10.26期间
- 差异达到 **-0.0219 笔/K线**，说明7.10-9.26期间交易频率极低

### filled_levels 状态

| 时间段 | filled_levels 阻止次数 | filled_levels 重置次数 | filled_levels 平均数量 |
|--------|----------------------|---------------------|---------------------|
| 7.10-10.26 | 0 | 0 | 0.0 |
| 9.26-10.26 | 0 | 0 | 0.0 |

**结论**：
- **filled_levels 不是问题**
- filled_levels 数量一直为0，没有阻止任何订单

### 订单阻止原因

两个时间段都被阻止了3次，原因都是：
- **Breakout risk-off (downside)**

**结论**：
- 订单阻止不是主要问题
- 只有3次订单被阻止，影响很小

## 问题分析

### 1. 核心问题：订单触发频率差异

**发现**：
- 7.10-10.26期间订单触发数：1217次
- 9.26-10.26期间订单触发数：1321次
- 差异：-104次

**分析**：
- 如果7.10-10.26期间包含9.26-10.26，那么7.10-10.26期间的订单触发数应该 >= 9.26-10.26期间的订单触发数
- 但实际上7.10-10.26期间的订单触发数更少
- 这说明：**9.26-10.26期间的订单触发数在7.10-10.26回测中减少了**

### 2. 可能的原因

#### A. 状态累积问题（最可能）★★★★★

**假设**：
- 7.10-9.26期间，某些状态（如 `pending_limit_orders`, `buy_positions`）累积
- 导致9.26-10.26期间的订单触发逻辑异常
- 订单触发频率降低，交易数量减少

**证据**：
- 订单触发数减少（1217 vs 1321）
- 交易频率差异很大（0.0076 vs 0.0295）

#### B. 订单触发条件问题

**可能的问题**：
- `check_limit_order_triggers` 中的条件检查
- 价格是否触及限价单价格（`touched` 条件）
- `pending_limit_orders` 的状态管理
- 订单的 `triggered` 标志没有正确重置

#### C. 卖出订单匹配问题

**可能的问题**：
- `match_sell_order` 可能返回 `None`
- 导致卖出订单无法匹配，持仓无法减少
- 进而影响后续买入订单的执行
- 但交易数量 = 卖出订单匹配次数，如果匹配失败，交易数量会减少

### 3. 为什么交易数量减少？

**关键发现**：
- 交易数量 = 卖出订单匹配 `long_positions` 的次数
- 如果卖出订单无法匹配，交易数量会减少

**可能的原因**：
1. 7.10-9.26期间，`long_positions` 状态异常
2. 9.26-10.26期间，卖出订单无法正确匹配到 `long_positions`
3. 导致交易数量减少

## 建议的进一步诊断

### 1. 添加订单触发日志

需要添加日志来检查：
- 订单是否被触发？
- 为什么没有被触发？
- `pending_limit_orders` 的状态如何？

### 2. 添加卖出订单匹配日志

需要添加日志来检查：
- 卖出订单是否成功匹配？
- `match_sell_order` 是否返回 `None`？
- 如果匹配失败，为什么？

### 3. 添加状态累积日志

需要添加日志来检查：
- `pending_limit_orders` 的数量变化
- `buy_positions` 的数量变化
- 这些状态在7.10-9.26期间如何累积

## 结论

1. **filled_levels 不是问题** - 数量一直为0，没有阻止任何订单
2. **订单阻止不是主要问题** - 只有3次订单被阻止
3. **核心问题：订单触发频率差异** - 7.10-10.26期间订单触发数更少
4. **最可能的原因：状态累积问题** - 7.10-9.26期间的状态累积导致9.26-10.26期间的订单触发逻辑异常

## 下一步行动

1. 添加更详细的订单触发日志
2. 添加卖出订单匹配日志
3. 添加状态累积日志
4. 重新运行回测，分析日志输出
