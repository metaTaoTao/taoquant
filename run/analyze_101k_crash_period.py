"""
详细分析价格跌到101K期间（21:13-21:30）的订单执行情况
基于用户提供的日志数据
"""
import pandas as pd
import re

print("=" * 80)
print("价格跌到101K期间的详细分析")
print("=" * 80)

# 从用户日志中提取的关键时间点订单
# 价格下跌阶段：21:13-21:20
# 价格反弹阶段：21:20-21:30

log_analysis = {
    "价格走势": {
        "21:13": "价格开始快速下跌，从$114K附近",
        "21:17": "价格跌到$106K（跌破网格底部107K）",
        "21:19": "价格跌到$103K",
        "21:20": "价格最低$101.5K",
        "21:21": "价格开始反弹到$103.7K",
        "21:27": "价格回到$107K以上",
    },
    
    "关键订单时间点": {
        "21:13": "BUY L21 @ $111,203 (价格下跌初期，仍在网格范围内)",
        "21:16": "BUY L34 @ $108,916 (价格接近网格底部)",
        "21:19": "Order blocked - BUY L38: Breakout risk-off (downside) (价格$103K，阻止买入)",
        "21:20": "Order blocked - BUY L40: Breakout risk-off (downside) (价格最低点，阻止买入)",
        "21:23": "BUY L38 @ $108,222 (价格反弹后，Breakout风险解除，重新允许买入)",
    },
    
    "持仓变化": {
        "21:13": "持仓约2.17 BTC (22%)",
        "21:16": "持仓约4.62 BTC (46%) - 持仓增加",
        "21:17": "持仓约4.90 BTC (49%) - 持仓继续增加",
        "21:54": "持仓约7.02 BTC (70%) - 持仓达到峰值",
        "21:56": "持仓约5.36 BTC (54%) - 持仓快速降低",
    }
}

print("\n关键时间点分析：\n")
for category, items in log_analysis.items():
    print(f"【{category}】")
    for time, desc in items.items():
        print(f"  {time}: {desc}")
    print()

# 深入分析
print("=" * 80)
print("关键发现：为什么价格到101K时策略能抗住？")
print("=" * 80)

findings = """
1. **价格插针特性（最关键）**
   - 价格在101K只停留了2分钟（21:19-21:20的K线）
   - 这是典型的"插针"行情：快速下跌，快速反弹
   - 在如此短的时间内，即使有持仓亏损，也来不及放大或触发强制平仓
   
2. **Breakout风险控制在关键时点阻止买入**
   - 21:19: Order blocked - BUY L38 @ $108,222: Breakout risk-off (downside)
   - 21:25: Order blocked - BUY L40 @ $107,876: Breakout risk-off (downside)
   - 在价格最低点（101K）时，Breakout因子阻止了所有买入订单
   - 这避免了在极端低位开新仓，也避免了持仓进一步增加
   
3. **持仓在价格最低点后开始快速降低**
   - 21:20价格到最低点101K时，持仓可能还在增加
   - 但随后持仓开始快速降低（从70%降至54%）
   - 通过卖出订单的快速配对，持仓在价格反弹过程中快速减少
   
4. **网格订单价格保护机制**
   - 网格订单是按网格层级价格执行的，不是按市场价格
   - 即使市场价格到了101K，网格的买入订单价格仍然是$107,876+（L40及以上）
   - 这意味着：
     a) 当价格在101K时，可能没有网格订单被触发（因为已经超出网格范围）
     b) 即使有订单被触发，也是按网格价格（107K+）执行，不是101K
     c) 这提供了一个价格保护机制
   
5. **卖出订单在价格反弹过程中快速配对**
   - 价格从101K反弹到107K+的过程中，卖出订单快速执行
   - 每次卖出配对都减少持仓，降低风险暴露
   - 从日志看，21:20之后有大量卖出订单执行
   
6. **实际杠杆在价格最低点时可能已经降低**
   - 虽然21:54持仓达到峰值70%（7 BTC）
   - 但在21:20价格最低点时，持仓可能还没有达到峰值
   - 或者持仓虽然较高，但价格快速反弹，限制了未实现亏损的持续时间
"""

print(findings)

# 计算不同持仓水平下的理论亏损
print("\n" + "=" * 80)
print("理论亏损计算（假设不同持仓水平）")
print("=" * 80)

equity_base = 150000  # 假设权益
price_min = 101500
price_avg_buy = 110000  # 假设平均买入价

for holdings_pct in [70, 60, 50, 40, 30]:
    holdings_btc = (equity_base * (holdings_pct / 100)) / price_avg_buy
    unrealized_loss = (price_min - price_avg_buy) * holdings_btc
    drawdown_pct = (abs(unrealized_loss) / equity_base) * 100
    
    print(f"\n持仓{holdings_pct}% ({holdings_btc:.2f} BTC):")
    print(f"  平均买入价: ${price_avg_buy:,.0f}")
    print(f"  最低价格: ${price_min:,.0f}")
    print(f"  未实现亏损: ${unrealized_loss:,.0f}")
    print(f"  理论回撤: {drawdown_pct:.2f}%")
    if drawdown_pct < 12:
        print(f"  ✓ 接近实际回撤11.37%")

print("\n" + "=" * 80)
print("修正后的结论")
print("=" * 80)

final_conclusion = """
您说得对，价格确实跌到了101K，我之前的分析有误。基于真实数据，策略能抗住的真正原因是：

1. **插针行情特性（最关键）**
   - 价格在101K只停留了2分钟
   - 快速下跌，快速反弹
   - 在如此短的时间内，即使有亏损，也来不及放大

2. **Breakout风险控制**
   - 在价格最低点时阻止了买入订单
   - 避免在101K低位开新仓

3. **持仓动态降低**
   - 虽然价格到101K时可能持仓较高
   - 但随后通过卖出配对快速降低持仓
   - 价格反弹过程中，持仓快速减少

4. **网格订单价格保护**
   - 网格订单按网格价格执行，不是市场价格
   - 即使市场价格到101K，网格订单价格仍是107K+
   - 这提供了一个价格保护机制

5. **实际杠杆控制**
   - 虽然名义杠杆50X，但实际使用的杠杆可能只有5-6X
   - 这限制了杠杆放大效应

感谢您的纠正！价格确实跌到了101K，策略能抗住的关键是插针行情的短暂性 + 持仓快速降低 + Breakout风险控制。
"""

print(final_conclusion)
