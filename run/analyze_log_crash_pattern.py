"""
基于用户提供的日志分析10.10-10.11暴跌期间的订单执行模式
"""
import re
from datetime import datetime

# 从用户日志中提取的关键订单模式（10.10 20:56 - 10.11 04:00期间）
# 基于日志分析关键模式

print("=" * 80)
print("基于日志分析：10.10-10.11暴跌期间的策略抗压机制")
print("=" * 80)

# 关键观察点
observations = {
    "订单频率": {
        "描述": "从日志看，10.10 20:56开始订单执行极其频繁",
        "数据": "几乎每分钟都有多个订单触发",
        "影响": "高频交易形成天然对冲，快速平仓减少暴露"
    },
    
    "网格层级覆盖": {
        "描述": "订单分布在多个网格层级（L12-L40）",
        "数据": "买入订单从L40（$107,876）到L12（$112,815）",
        "影响": "价格分散在网格区间，避免集中风险"
    },
    
    "配对执行模式": {
        "描述": "卖出订单立即触发买入订单（re-entry）",
        "模式": "SELL L33 → 立即 BUY L33 (re-entry)",
        "影响": "网格配对机制确保快速平仓和重新开仓，维持市场中性"
    },
    
    "持仓动态变化": {
        "描述": "持仓百分比在暴跌期间动态调整",
        "观察": "从Inventory显示看，持仓百分比在0%-70%之间波动",
        "影响": "动态持仓管理避免单边暴露风险"
    },
    
    "价格区间": {
        "描述": "暴跌期间价格主要在$107K-$113K区间",
        "范围": "价格在网格设定的S/R区间（107K-123K）内",
        "影响": "策略依然在有效区间内运行，网格机制正常工作"
    },
    
    "Breakout风险控制": {
        "描述": "部分买入订单被Breakout风险因子阻止",
        "示例": "[2025-10-10 21:19:00] Order blocked - BUY L38 @ $108,222: Breakout risk-off (downside)",
        "影响": "在极端下跌时减少买入，降低风险暴露"
    },
    
    "持仓逐步降低": {
        "描述": "从日志看，在暴跌初期持仓较高（70%+），但随后逐步降低",
        "观察": "10.10 21:54时持仓达到70%（7.02 BTC），但后续逐步降低",
        "影响": "通过卖出配对和不再开新仓，逐步降低风险暴露"
    }
}

print("\n关键观察点分析：\n")
for key, info in observations.items():
    print(f"【{key}】")
    for subkey, value in info.items():
        print(f"  {subkey}: {value}")
    print()

# 分析关键机制
print("=" * 80)
print("策略抗压机制总结")
print("=" * 80)

mechanisms = """
1. **网格配对机制（Grid Pairing）**
   - 卖出订单优先匹配同层级的买入订单
   - 即使价格暴跌，卖出订单能快速锁定利润或限制亏损
   - 每次配对都减少持仓，降低风险暴露
   
2. **动态持仓管理**
   - 持仓在暴跌期间通过频繁的买卖配对迅速降低
   - 从日志看，持仓从70%逐步降低到更低水平
   - 避免大量单边持仓暴露在极端行情中
   
3. **价格区间控制**
   - 网格订单分散在$107K-$123K价格区间内
   - 即使在暴跌时，价格仍在该区间内，网格机制有效
   - 部分订单仍能盈利配对，提供现金流
   
4. **实际杠杆控制**
   - 虽然名义杠杆50X，但通过配对机制，实际持仓逐步降低
   - 持仓价值/权益的比率（实际杠杆）远低于50X
   - 从日志看，最大持仓约70%（约7 BTC），对应约$700K持仓价值
   - 如果权益在$150K左右，实际杠杆约4.7X，而非50X
   
5. **Breakout风险控制**
   - 在极端下跌时，Breakout风险因子阻止部分买入订单
   - 减少在下跌趋势中的逆势买入，降低风险
   
6. **频繁交易对冲**
   - 暴跌期间每分钟都有多个订单执行
   - 每次卖出配对都减少持仓，形成天然对冲
   - 高频交易让持仓能够快速调整，而不是被动持有
   
7. **网格re-entry机制**
   - 每次卖出后立即在同一层级放置买入订单（re-entry）
   - 如果价格反弹，能快速重新开仓
   - 如果价格继续下跌，减少买入，降低暴露
   
8. **成本基础及时更新（FIFO Fallback）**
   - 卖出订单即使无法匹配同层级买入，也会通过FIFO机制匹配
   - total_cost_basis及时减少，避免未实现亏损虚高
   - 这是之前修复的关键bug，确保风控逻辑正确
"""

print(mechanisms)

print("\n" + "=" * 80)
print("为什么50X杠杆只有11.37%最大回撤？")
print("=" * 80)

explanation = """
关键原因：

1. **实际杠杆远低于名义杠杆**
   - 名义杠杆50X是指最大可用杠杆，不是实际使用的杠杆
   - 实际杠杆 = 持仓价值 / 权益
   - 从日志看，即使在持仓最高点（约70%，7 BTC），持仓价值约$700K
   - 如果此时权益约$150K，实际杠杆约4.7X，而非50X
   - 因此回撤不会因为杠杆放大而急剧恶化

2. **快速持仓降低机制**
   - 暴跌期间，卖出订单快速配对，持仓迅速降低
   - 从70%持仓可能在几小时内降低到20-30%
   - 持仓降低后，实际杠杆进一步下降
   - 因此最大回撤发生在持仓较高时，但后续持仓降低限制了进一步损失

3. **价格仍在网格有效区间**
   - 暴跌后价格（$107K-$113K）仍在网格设定的S/R区间（107K-123K）内
   - 网格机制依然有效，订单能够正常配对
   - 如果价格跌破网格区间，风险会更大

4. **网格间距提供了缓冲**
   - 网格订单分散在不同价格层级
   - 即使价格快速下跌，也有足够的网格层级吸收
   - 每次配对都锁定一部分利润或限制亏损

5. **成本基础正确计算**
   - 修复后的FIFO机制确保total_cost_basis正确更新
   - 避免未实现亏损虚高导致风控误判
   - 确保风控逻辑基于真实的风险状态
"""

print(explanation)

print("\n分析完成！")
