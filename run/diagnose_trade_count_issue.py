"""
诊断为什么延长回测时间后交易次数反而减少
关键发现：交易数量 = 卖出订单匹配的次数
"""
import sys
from pathlib import Path

project_root = Path(__file__).parent.parent
sys.path.insert(0, str(project_root))

print("=" * 80)
print("诊断：为什么延长回测时间后交易次数反而减少？")
print("=" * 80)

print("\n关键发现：")
print("  交易数量 = 卖出订单匹配 long_positions 的次数")
print("  每次卖出订单匹配一个买入持仓，就记录一个交易")
print("  买入订单本身不记录交易，只是添加到 long_positions")

print("\n" + "=" * 80)
print("可能的原因分析")
print("=" * 80)

possible_reasons = """
1. 【7.10-9.26期间买入订单很少，导致后续没有持仓可卖】
   
   如果7.10-9.26期间：
   - 因子过滤阻止了大部分买入订单（Breakout Risk, Trend Score等）
   - 库存限制阻止了买入（库存比率一直很高）
   - 价格波动率低，网格订单触发频率低
   
   那么：
   - long_positions 很少
   - 即使有卖出订单，也没有持仓可匹配
   - 交易数量 = 0 或很少
   
   影响：
   - 7.10-9.26期间交易很少
   - 9.26之后，如果买入订单也很少，交易仍然很少
   - 总交易数量 = 7.10-9.26期间的交易 + 9.26-10.26期间的交易
   - 如果7.10-9.26期间交易很少，总交易数量可能反而减少

2. 【7.10-9.26期间卖出订单很少】
   
   如果7.10-9.26期间：
   - 价格波动率低，卖出订单触发频率低
   - 价格一直在买入区域，没有触发卖出订单
   
   那么：
   - 即使有持仓，也没有卖出订单来匹配
   - 交易数量 = 0 或很少

3. 【网格状态累积问题】
   
   如果7.10-9.26期间：
   - 网格在某个时间点被关闭，之后没有重新启用
   - 或者网格状态（filled_levels, pending_orders等）出现问题
   - 导致后续订单无法正常触发
   
   那么：
   - 7.10-9.26期间交易很少
   - 9.26之后，网格状态可能仍然有问题
   - 总交易数量减少

4. 【卖出订单匹配失败】
   
   如果7.10-9.26期间：
   - 卖出订单很多，但 long_positions 很少
   - 或者匹配逻辑有问题，导致匹配失败
   
   那么：
   - matched_trades = []（空列表）
   - 交易数量 = 0

5. 【数据或代码逻辑问题】
   
   如果：
   - 7.10-9.26期间的数据有问题
   - 或者代码逻辑在某个时间点出现问题
   
   那么：
   - 交易记录可能不完整
   - 或者某些交易没有被正确记录
"""

print(possible_reasons)

print("\n" + "=" * 80)
print("最可能的原因")
print("=" * 80)

most_likely = """
基于代码逻辑分析，最可能的原因是：

1. 【7.10-9.26期间买入订单很少，导致后续没有持仓可卖】★★★★★
   
   如果7.10-9.26期间：
   - 因子过滤阻止了大部分买入订单
   - 或者价格波动率低，网格订单触发频率低
   
   那么：
   - long_positions 很少或为空
   - 即使有卖出订单，也没有持仓可匹配
   - 交易数量 = 0 或很少
   
   这解释了为什么：
   - 9.26-10.26（30天）：1274笔交易
   - 7.10-10.26（108天）：1179笔交易
   - 7.10-9.26（78天）：可能只有 -95笔交易（负数！）
   
   这说明7.10-9.26期间可能：
   - 买入订单很少，导致 long_positions 很少
   - 卖出订单也很少，或者卖出订单无法匹配（因为没有持仓）
   - 总交易数量反而减少了

2. 【网格状态累积问题】★★★★
   
   如果7.10-9.26期间：
   - 网格在某个时间点被关闭或状态异常
   - 导致后续订单无法正常触发
   
   那么：
   - 7.10-9.26期间交易很少
   - 9.26之后，网格状态可能仍然有问题
   - 总交易数量减少

3. 【卖出订单匹配失败】★★★
   
   如果7.10-9.26期间：
   - 卖出订单很多，但 long_positions 很少
   - 或者匹配逻辑有问题，导致匹配失败
   
   那么：
   - matched_trades = []（空列表）
   - 交易数量 = 0
"""

print(most_likely)

print("\n" + "=" * 80)
print("建议的检查方法")
print("=" * 80)

suggestions = """
1. 【检查7.10-9.26期间的订单分布】
   
   运行回测，分别统计：
   - 7.10-9.26期间的买入订单数
   - 7.10-9.26期间的卖出订单数
   - 7.10-9.26期间的交易数
   
   对比：
   - 9.26-10.26期间的买入订单数
   - 9.26-10.26期间的卖出订单数
   - 9.26-10.26期间的交易数

2. 【检查7.10-9.26期间的因子状态】
   
   在回测日志中搜索：
   - "Order blocked"
   - "Breakout risk-off"
   - "Inventory de-risk"
   - 查看7.10-9.26期间是否有大量订单被阻止

3. 【检查卖出订单匹配情况】
   
   在回测日志中检查：
   - 卖出订单的 matched_trades 数量
   - 如果 matched_trades = 0，说明匹配失败
   - 这会导致交易数量减少

4. 【检查网格状态】
   
   在回测日志中搜索：
   - "GRID SHUTDOWN"
   - "Grid disabled"
   - 查看7.10-9.26期间网格是否被关闭

5. 【分段回测验证】
   
   分别运行：
   - 7.10-9.26的回测
   - 9.26-10.26的回测
   - 7.10-10.26的回测
   
   对比交易数量，找出差异
"""

print(suggestions)

print("\n" + "=" * 80)
print("代码逻辑检查")
print("=" * 80)

code_logic = """
关键代码逻辑（simple_lean_runner.py:567-568）：

```python
# Record all matched trades
self.trades.extend(matched_trades)
```

交易记录的条件：
1. 必须有卖出订单
2. 卖出订单必须匹配到 long_positions
3. 每次匹配成功，就记录一个交易

如果7.10-9.26期间：
- 买入订单很少 → long_positions 很少
- 卖出订单很多，但无法匹配 → matched_trades = []
- 结果：交易数量 = 0

如果9.26-10.26期间：
- 买入订单正常 → long_positions 正常
- 卖出订单正常，匹配成功 → matched_trades 正常
- 结果：交易数量 = 1274

如果7.10-10.26期间：
- 7.10-9.26：买入订单很少，卖出订单无法匹配 → 交易数量 = 0 或很少
- 9.26-10.26：买入订单正常，卖出订单匹配成功 → 交易数量 = 1274
- 但总交易数量 = 1179 < 1274

这说明：
- 7.10-9.26期间可能产生了负的交易数量（不可能！）
- 或者9.26-10.26期间的交易数量在7.10-10.26回测中减少了
- 这可能是网格状态累积问题，或者代码逻辑问题
"""

print(code_logic)

print("\n" + "=" * 80)
print("总结")
print("=" * 80)

summary = """
为什么延长回测时间后交易次数反而减少？

最可能的原因：
1. 7.10-9.26期间买入订单很少，导致后续没有持仓可卖
2. 网格状态累积问题，导致后续订单无法正常触发
3. 卖出订单匹配失败，导致交易没有被记录

建议：
1. 检查7.10-9.26期间的订单分布和因子状态
2. 检查卖出订单的匹配情况
3. 分段回测验证，找出具体原因
"""

print(summary)
