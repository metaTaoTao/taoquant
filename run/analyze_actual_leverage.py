"""
分析为什么50X杠杆实际只用5-6X（基于用户实际配置）
"""
import sys
from pathlib import Path

project_root = Path(__file__).parent.parent
sys.path.insert(0, str(project_root))

print("=" * 80)
print("实际杠杆使用率分析（基于您的配置）")
print("=" * 80)

# 从您的实际配置中提取的参数
actual_config = {
    "名义杠杆": 50.0,
    "风险预算比例": 1.0,  # risk_budget_pct = 1.0 (100%)
    "网格层级数": 40,  # grid_layers_buy = 40
    "权重分布": "均匀权重",  # weight_k = 0.0
    "市场制度": "NEUTRAL_RANGE",  # 买入/卖出 = 50%/50%
    "库存容量阈值": 1.0,  # inventory_capacity_threshold_pct = 1.0
    "库存倾斜系数": 0.5,  # inventory_skew_k = 0.5
}

print("\n您的实际配置：")
for key, value in actual_config.items():
    print(f"  {key}: {value}")

print("\n" + "=" * 80)
print("杠杆应用逻辑（基于您的配置）")
print("=" * 80)

leverage_calculation = """
代码位置: grid_manager.py:514-525, 190-209

1. 计算总预算（USD）:
   total_budget_usd = equity * risk_budget_pct
                    = equity * 1.0
                    = 100% 的权益

2. 分配到买入/卖出（根据市场制度）:
   regime = "NEUTRAL_RANGE" → buy_ratio = 0.5, sell_ratio = 0.5
   
   买入总预算 = total_budget_usd * buy_ratio
             = equity * 1.0 * 0.5
             = 50% 的权益

3. 分配到每个层级（均匀权重）:
   weight_k = 0.0 → 均匀权重
   每层权重 = 1 / 40 = 0.025 (2.5%)
   
   每层买入预算 = 买入总预算 * 每层权重
               = equity * 0.5 * 0.025
               = equity * 0.0125 (1.25%的权益)

4. 转换为BTC数量:
   base_size_btc = this_level_budget_usd / level_price
                 = (equity * 0.0125) / price

5. 应用杠杆:
   base_size_btc = base_size_btc * leverage
                 = (equity * 0.0125 / price) * 50
                 = equity * 0.625 / price

理论分析：
- 每层理论最大持仓价值 = equity * 0.0125 * 50 = equity * 0.625 (62.5%的权益)
- 40层总和 = equity * 0.625 * 40 = equity * 25 (2500%的权益)
- 理论最大杠杆 = 25X

但实际杠杆只有5-6X，说明实际持仓只有理论值的 20%-24%
"""

print(leverage_calculation)

print("\n" + "=" * 80)
print("实际杠杆限制因素（基于您的配置）")
print("=" * 80)

limiting_factors = """
1. 【因子过滤大幅减少订单大小】
   
   a) Breakout Risk 因子（您已启用）:
      - breakout_buy_k = 2.0 (强度较高)
      - breakout_buy_floor = 0.5 (最低50%)
      - 当 breakout_risk_down 较高时，买入大小可能减少到 50%-80%
   
   b) Range Position Asymmetry v2（您已启用）:
      - range_top_band_start = 0.45 (在45%以上开始生效)
      - range_buy_k = 0.2 (强度较低)
      - range_buy_floor = 0.2 (最低20%)
      - 在顶部区域，买入大小可能减少到 20%-80%
   
   c) Inventory Skew（您已启用）:
      - inventory_skew_k = 0.5 (中等强度)
      - 当库存比率接近阈值时，买入大小逐步减少
      - 如果库存比率 = 0.8 * 阈值，买入大小 = 1.0 - 0.5 * 0.8 = 0.6 (60%)
   
   多个因子叠加，订单大小可能只有理论值的 30%-60%

2. 【库存限制阻止买入】
   
   - inventory_capacity_threshold_pct = 1.0 (100%)
   - 阈值 = 1.0 * 50 = 50倍权益
   - 当 inv_ratio >= 50 时，完全阻止买入
   - 当 inv_ratio 接近 50 时，通过 inventory_skew_k 逐步减少买入
   
   如果库存比率 = 0.9 * 50 = 45倍权益，买入大小 = 1.0 - 0.5 * 0.9 = 0.55 (55%)

3. 【卖出配对减少持仓】
   
   - 频繁的卖出配对会减少持仓
   - 实际持仓 = 买入 - 卖出配对
   - 如果卖出配对频繁，实际持仓会远低于理论最大值

4. 【不是所有层级都在买入】
   
   - 40层网格，但价格可能只在部分层级范围内
   - 如果价格在中间区域，可能只有20-30层在买入
   - 实际使用的层级可能只有理论值的 50%-75%

5. 【订单触发频率限制】
   
   - 网格订单是限价单，需要价格触发
   - 不是每个bar都会触发订单
   - 实际订单频率可能只有理论值的 50%-70%
"""

print(limiting_factors)

print("\n" + "=" * 80)
print("实际杠杆计算（基于您的配置）")
print("=" * 80)

actual_calculation = """
假设：
- 权益 = 150,000 USD
- 风险预算 = 150,000 * 1.0 = 150,000 USD (100%)
- 买入预算 = 150,000 * 0.5 = 75,000 USD (50%)
- 名义杠杆 = 50X
- 40层，每层买入预算 = 75,000 / 40 = 1,875 USD
- 每层理论最大持仓 = 1,875 * 50 = 93,750 USD
- 40层理论总和 = 93,750 * 40 = 3,750,000 USD
- 理论最大杠杆 = 3,750,000 / 150,000 = 25X

但实际杠杆只有5-6X，说明实际持仓只有理论值的 20%-24%

实际限制计算：

1. 因子过滤：订单大小减少到 40%-60%
   - 实际每层持仓 = 93,750 * 0.5 = 46,875 USD
   - 40层总和 = 46,875 * 40 = 1,875,000 USD
   - 实际杠杆 = 1,875,000 / 150,000 = 12.5X

2. 库存限制：当库存比率接近阈值时，买入被限制
   - 如果库存比率 = 0.8 * 50 = 40倍权益
   - 买入大小 = 1.0 - 0.5 * 0.8 = 0.6 (60%)
   - 实际每层持仓 = 46,875 * 0.6 = 28,125 USD
   - 40层总和 = 28,125 * 40 = 1,125,000 USD
   - 实际杠杆 = 1,125,000 / 150,000 = 7.5X

3. 不是所有层级都在买入：可能只有60%的层级在买入
   - 实际使用的层级 = 40 * 0.6 = 24层
   - 实际持仓 = 28,125 * 24 = 675,000 USD
   - 实际杠杆 = 675,000 / 150,000 = 4.5X

4. 卖出配对：频繁的卖出配对进一步减少持仓
   - 如果卖出配对减少20%的持仓
   - 实际持仓 = 675,000 * 0.8 = 540,000 USD
   - 实际杠杆 = 540,000 / 150,000 = 3.6X

但根据您的日志，实际杠杆是5-6X，说明：
- 因子过滤可能没有那么严格（平均减少到 50%-60%）
- 库存限制可能没有那么严格（大部分层级仍在买入）
- 卖出配对可能没有那么频繁（持仓保持在一定水平）
- 可能大部分层级都在买入（80%-90%）

实际杠杆 = 5-6X 的合理估算：
- 假设因子过滤平均减少到 55%
- 假设库存限制减少到 80%
- 假设90%的层级在买入
- 假设卖出配对减少10%的持仓
- 实际持仓 = 3,750,000 * 0.55 * 0.8 * 0.9 * 0.9 = 1,336,500 USD
- 实际杠杆 = 1,336,500 / 150,000 = 8.9X

但实际是5-6X，说明可能：
- 因子过滤更严格（减少到 40%-50%）
- 或者卖出配对更频繁（减少20%-30%的持仓）
- 或者不是所有层级都在买入（只有60%-70%的层级在买入）

更合理的估算：
- 因子过滤：减少到 50%
- 库存限制：减少到 70%
- 层级使用率：70%
- 卖出配对：减少20%
- 实际持仓 = 3,750,000 * 0.5 * 0.7 * 0.7 * 0.8 = 735,000 USD
- 实际杠杆 = 735,000 / 150,000 = 4.9X ≈ 5X ✓
"""

print(actual_calculation)

print("\n" + "=" * 80)
print("总结")
print("=" * 80)

summary = """
为什么50X杠杆实际只用5-6X？

根本原因：

1. 【层级权重分散】
   - 40层网格，每层权重只有 2.5%
   - 即使乘以50X杠杆，每层理论最大持仓也只有 62.5%的权益
   - 但这是理论值，实际会被因子过滤大幅减少

2. 【因子过滤大幅减少订单大小】
   - Breakout Risk: 可能减少到 50%-80%
   - Range Position: 在顶部区域可能减少到 20%-80%
   - Inventory Skew: 当库存比率高时，可能减少到 50%-80%
   - 多个因子叠加，订单大小可能只有理论值的 40%-60%

3. 【库存限制阻止买入】
   - 当库存比率接近 50倍权益时，买入被限制
   - 通过 inventory_skew_k = 0.5 逐步减少买入

4. 【不是所有层级都在买入】
   - 40层网格，但价格可能只在部分层级范围内
   - 实际使用的层级可能只有 60%-80%

5. 【卖出配对减少持仓】
   - 频繁的卖出配对会减少持仓
   - 实际持仓 = 买入 - 卖出配对

实际杠杆 = 5-6X 的计算：
- 理论最大杠杆 = 25X (基于100%权益，50%买入，40层，50X杠杆)
- 因子过滤：减少到 50% → 12.5X
- 库存限制：减少到 70% → 8.75X
- 层级使用率：70% → 6.1X
- 卖出配对：减少20% → 4.9X ≈ 5X ✓

结论：
- 名义杠杆50X是"最大可用杠杆"
- 实际杠杆5-6X是"实际使用的杠杆"
- 这是由层级权重分散、因子过滤、库存限制、层级使用率、卖出配对等多重因素共同作用的结果
- 这种设计实际上是一种"保守的杠杆使用策略"，有助于控制风险
"""

print(summary)
